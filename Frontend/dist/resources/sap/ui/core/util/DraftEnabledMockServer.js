/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/MockServer","sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","jquery.sap.sjax"],function(t,jQuery,a){"use strict";return{_oDraftMetadata:{},_oConstants:{COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT:"com.sap.vocabularies.Common.v1.DraftRoot",COM_SAP_VOCABULARIES_COMMON_V1_DRAFTNODE:"com.sap.vocabularies.Common.v1.DraftNode",COM_SAP_VOCABULARIES_COMMON_V1_SEMANTICKEY:"com.sap.vocabularies.Common.v1.SemanticKey",EMPTY_GUID:"00000000-0000-0000-0000-000000000000",SIBLINGENTITY_NAVIGATION:"SiblingEntity",DRAFT_ADMINISTRATIVE_DATA:"DraftAdministrativeData",DRAFT_ADMINISTRATIVE_DATA_UUID:"DraftAdministrativeDataUUID",ACTIVATION_ACTION:"ActivationAction",EDIT_ACTION:"EditAction",VALIDATE_ACTION:"ValidationFunction",PREPARE_ACTION:"PreparationAction"},handleDraft:function(a,e){var r=function(t){var a=t.getParameter("oEntity");a.IsActiveEntity=false;a.HasActiveEntity=false;a.HasDraftEntity=false};var o=function(t){var a=t.getParameter("oXhr");var e=jQuery.sap.sjax({url:a.url,dataType:"json"}).data.d;for(var r=0;r<this._oDraftMetadata.draftNodes.length;r++){for(var o in this._mEntitySets[this._oDraftMetadata.draftRootName].navprops){if(this._mEntitySets[this._oDraftMetadata.draftRootName].navprops[o].to.entitySet===this._oDraftMetadata.draftNodes[r]){var i=jQuery.sap.sjax({url:e[o].__deferred.uri,dataType:"json"});if(i.data&&i.data.d&&i.data.d.results){var s;for(var n=0;n<i.data.d.results.length;n++){s=i.data.d.results[n];jQuery.sap.sjax({url:s.__metadata.uri,type:"DELETE"})}}}}}};if(a&&a.EntityContainer){var i=a.EntityContainer[Object.keys(a.EntityContainer)[0]];for(var s in i){var n=i[s];if(n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT]){this._oDraftMetadata.draftRootName=s;this._oDraftMetadata.annotations=a;this._oDraftMetadata.mockServerRootUri=e.getRootUri();if(n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.ACTIVATION_ACTION]){this._oDraftMetadata.draftRootActivationName=n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.ACTIVATION_ACTION].String}if(this._oDraftMetadata.draftRootActivationName){this._oDraftMetadata.draftRootActivationName=this._oDraftMetadata.draftRootActivationName.substring(this._oDraftMetadata.draftRootActivationName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootEditName=n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.EDIT_ACTION];this._oDraftMetadata.draftRootEditName=this._oDraftMetadata.draftRootEditName?this._oDraftMetadata.draftRootEditName.String:undefined;if(this._oDraftMetadata.draftRootEditName){this._oDraftMetadata.draftRootEditName=this._oDraftMetadata.draftRootEditName.substring(this._oDraftMetadata.draftRootEditName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootValidationName=n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.VALIDATE_ACTION];this._oDraftMetadata.draftRootValidationName=this._oDraftMetadata.draftRootValidationName?this._oDraftMetadata.draftRootValidationName.String:undefined;if(this._oDraftMetadata.draftRootValidationName){this._oDraftMetadata.draftRootValidationName=this._oDraftMetadata.draftRootValidationName.substring(this._oDraftMetadata.draftRootValidationName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootPreparationtionName=n[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.PREPARE_ACTION];this._oDraftMetadata.draftRootPreparationtionName=this._oDraftMetadata.draftRootPreparationtionName?this._oDraftMetadata.draftRootPreparationtionName.String:undefined;if(this._oDraftMetadata.draftRootPreparationtionName){this._oDraftMetadata.draftRootPreparationtionName=this._oDraftMetadata.draftRootPreparationtionName.substring(this._oDraftMetadata.draftRootPreparationtionName.lastIndexOf("/")+1)}jQuery.extend(e,this);e.attachAfter(t.HTTPMETHOD.POST,r,this._oDraftMetadata.draftRootName);e.attachBefore(t.HTTPMETHOD.DELETE,o,this._oDraftMetadata.draftRootName);e.attachAfter(t.HTTPMETHOD.GET,this._fnDraftAdministrativeData,this._oDraftMetadata.draftRootName)}}}},_calcSemanticKeys:function(t,a){var e=[];for(var r in this._oDraftMetadata.annotations){if(r.lastIndexOf(a[t].type)>-1){e=this._oDraftMetadata.annotations[r][this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_SEMANTICKEY]||[];break}}var o=[];var i;for(var s=0;s<e.length;s++){i=e[s];for(var n in i){o.push(i[n])}}return o},_prepareDraftMetadata:function(a){var e=this;this._oDraftMetadata.draftNodes=[];this._oDraftMetadata.draftRootKey=a[this._oDraftMetadata.draftRootName].keys.filter(function(t){return e._calcSemanticKeys(e._oDraftMetadata.draftRootName,a).indexOf(t)<0})[0];var r=e._oDraftMetadata.annotations;var o=r.EntityContainer[Object.keys(r.EntityContainer)[0]];for(var i in o){var s=o[i];if(s[e._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTNODE]){this._oDraftMetadata.draftNodes.push(i)}}for(var n=0;n<this._oDraftMetadata.draftNodes.length;n++){this.attachAfter(t.HTTPMETHOD.GET,this._fnDraftAdministrativeData,this._oDraftMetadata.draftNodes[n])}},_fnDraftAdministrativeData:function(t){var e={};var r=t.getParameter("oFilteredData");if(!r){e=t.getParameter("oEntry");if(e.IsActiveEntity&&!e.HasDraftEntity){e[this._oConstants.DRAFT_ADMINISTRATIVE_DATA]=null}}else{if(r.results){r=r.results}else{if(a(r)){r=null;return}}for(var o=0;o<r.length;o++){e=r[o];if(e.IsActiveEntity&&!e.HasDraftEntity){e[this._oConstants.DRAFT_ADMINISTRATIVE_DATA]=null}}}},_handleDraftArtifacts:function(t){var a=this;var e=this._oMockdata;var r=e[this._oDraftMetadata.draftRootName];var o=function(t,a){return t.filter(function(t){return a.indexOf(t)<0})[0]};if(r.length===100){for(var i=0;i<r.length;i++){var s=r[i];if(i<25){s.IsActiveEntity=true;s.HasActiveEntity=false;s.HasDraftEntity=false;s[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;if(s[this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]){s[this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]=null}var n=[];var f=[];for(var d=0;d<this._oDraftMetadata.draftNodes.length;d++){f=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[d],t);n=e[this._oDraftMetadata.draftNodes[d]];var _=t[this._oDraftMetadata.draftRootName];for(var D in _.navprops){var h=_.navprops[D];if(h.to.entitySet===this._oDraftMetadata.draftNodes[d]){var M=h.from.propRef.length;for(var v=0;v<M;v++){n[i][h.to.propRef[v]]=s[h.from.propRef[v]]}}}n[i].IsActiveEntity=true;n[i].HasActiveEntity=false;n[i].HasDraftEntity=false;n[i][this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;if(n[i][this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]){n[i][this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]=null}var A=o(t[this._oDraftMetadata.draftNodes[d]].keys,f);n[i][A]=this._oConstants.EMPTY_GUID}}else if(i<50){s.IsActiveEntity=false;s.HasActiveEntity=false;s.HasDraftEntity=false;n=[];f=[];for(var d=0;d<this._oDraftMetadata.draftNodes.length;d++){f=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[d],t);n=e[this._oDraftMetadata.draftNodes[d]];var _=t[this._oDraftMetadata.draftRootName];for(var D in _.navprops){var h=_.navprops[D];if(h.to.entitySet===this._oDraftMetadata.draftNodes[d]){var M=h.from.propRef.length;for(var v=0;v<M;v++){n[i][h.to.propRef[v]]=s[h.from.propRef[v]]}}}n[i].IsActiveEntity=false;n[i].HasActiveEntity=false;n[i].HasDraftEntity=false;A=o(t[this._oDraftMetadata.draftNodes[d]].keys,f)}}else if(i<75){var p=jQuery.extend(true,{},s);s.IsActiveEntity=true;s.HasActiveEntity=false;s.HasDraftEntity=true;s[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;n=[];f=[];for(var d=0;d<this._oDraftMetadata.draftNodes.length;d++){f=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[d],t);n=e[this._oDraftMetadata.draftNodes[d]];var _=t[this._oDraftMetadata.draftRootName];for(var D in _.navprops){var h=_.navprops[D];if(h.to.entitySet===this._oDraftMetadata.draftNodes[d]){var M=h.from.propRef.length;for(var v=0;v<M;v++){n[i][h.to.propRef[v]]=s[h.from.propRef[v]]}}}n[i].IsActiveEntity=true;n[i].HasActiveEntity=false;n[i].HasDraftEntity=true;A=o(t[this._oDraftMetadata.draftNodes[d]].keys,f);n[i][A]=this._oConstants.EMPTY_GUID}p.IsActiveEntity=false;p.HasActiveEntity=true;p.HasDraftEntity=false;r[i+25]=p}}}var E=this._getRootUri();jQuery.each(t,function(t,r){jQuery.each(e[t],function(e,o){o.__metadata=o.__metadata||{};o.__metadata.uri=E+t+"("+a._createKeysString(r,o)+")";o.__metadata.type=r.schema+"."+r.type;jQuery.each(r.navprops,function(e){o[e]={__deferred:{uri:E+t+"("+a._createKeysString(r,o)+")/"+e}}})})})},_activate:function(t){var a;var e=function(t,a){return t.filter(function(t){return a.indexOf(t)<0})[0]};for(var r=0;r<this._oDraftMetadata.draftNodes.length;r++){for(var o in this._mEntitySets[this._oDraftMetadata.draftRootName].navprops){if(this._mEntitySets[this._oDraftMetadata.draftRootName].navprops[o].to.entitySet===this._oDraftMetadata.draftNodes[r]){a=jQuery.sap.sjax({url:t[o].__deferred.uri,dataType:"json"});if(a.success&&a.data&&a.data.d&&a.data.d.results){var i;for(var s=0;s<a.data.d.results.length;s++){i=a.data.d.results[s];i.IsActiveEntity=true;i.HasActiveEntity=false;i.HasDraftEntity=false;i[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;var n=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[r],this._mEntitySets);var f=e(this._mEntitySets[this._oDraftMetadata.draftNodes[r]].keys,n);i[f]=this._oConstants.EMPTY_GUID;jQuery.sap.sjax({url:i.__metadata.uri,type:"PATCH",data:JSON.stringify(i)})}}}}}t.IsActiveEntity=true;t.HasActiveEntity=false;t.HasDraftEntity=false;t[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;jQuery.sap.sjax({url:t.__metadata.uri,type:"PATCH",data:JSON.stringify(t)});return t},setRequests:function(e){var r=this;e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootActivationName),response:function(t){var a=JSON.parse(t.requestBody);var e=[];for(var o in a){e.push(o+" eq "+a[o])}var i=jQuery.sap.sjax({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+e.join(" and "),dataType:"json"});if(!i.success||!i.data.d.results[0]){t.respond(404)}var s=i.data.d.results[0];if(s.IsActiveEntity){t.respond(400)}if(s.HasActiveEntity){var n=s.SiblingEntity.__deferred.uri;i=jQuery.sap.sjax({url:n,dataType:"json"});if(i.success&&i.data&&i.data.d.__metadata){var f=i.data.d;i=jQuery.sap.sjax({url:f.__metadata.uri,type:"DELETE"})}}s=r._activate(s);t.respondJSON(200,{},JSON.stringify({d:s}));return true}});if(r._oDraftMetadata.draftRootEditName){e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootEditName+"(\\?(.*))?"),response:function(t,e){var o=[];var i=JSON.parse(t.requestBody);if(i&&!a(i)){for(var s in i){o.push(s+" eq "+i[s])}}else{var n=decodeURIComponent(e).replace("?","&").split("&");for(var f in n){var d=n[f];var _=new RegExp("(.*)=(.*)");var D;if(d){D=_.exec(d);o.push(D[1]+" eq "+D[2])}}}var h=jQuery.sap.sjax({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+o.join(" and "),dataType:"json"});if(!h.success||!h.data.d.results[0]){t.respond(404)}var M=h.data.d.results[0];if(!M.IsActiveEntity||M.HasDraftEntity){t.respond(400)}var v=jQuery.extend(true,{},M);v.IsActiveEntity=false;v.HasActiveEntity=true;v.HasDraftEntity=false;v[r._oDraftMetadata.draftRootKey]=r._generatePropertyValue(r._oDraftMetadata.draftRootKey,"Guid");var A=r._getRootUri();var p=r._mEntitySets[r._oDraftMetadata.draftRootName];v.__metadata=v.__metadata||{};v.__metadata.uri=A+r._oDraftMetadata.draftRootName+"("+r._createKeysString(p,v)+")";v.__metadata.type=p.schema+"."+p.type;jQuery.each(p.navprops,function(t){v[t]={__deferred:{uri:A+r._oDraftMetadata.draftRootName+"("+r._createKeysString(p,v)+")/"+t}}});r._oMockdata[r._oDraftMetadata.draftRootName].push(v);h=jQuery.sap.sjax({url:M.__metadata.uri,type:"PATCH",data:JSON.stringify({HasDraftEntity:true})});t.respondJSON(200,{},JSON.stringify({d:v}));return true}})}if(r._oDraftMetadata.draftRootValidationName){e.push({method:"GET",path:new RegExp(r._oDraftMetadata.draftRootValidationName+"(\\?(.*))?"),response:function(a,e){var o=r._oDraftMetadata.draftRootValidationName;r.fireEvent(t.HTTPMETHOD.GET+o+":before",{oXhr:a,sUrlParams:e});r.fireEvent(t.HTTPMETHOD.GET+":before",{oXhr:a,sUrlParams:e});var i={d:{}};i.d[o]={__metadata:{type:"ValidationResult"},IsValid:true};r.fireEvent(t.HTTPMETHOD.GET+o+":after",{oXhr:a,oResult:i});r.fireEvent(t.HTTPMETHOD.GET+":after",{oXhr:a,oResult:i});a.respondJSON(200,{},JSON.stringify(i));return true}})}if(r._oDraftMetadata.draftRootPreparationtionName){e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootPreparationtionName),response:function(a){r.fireEvent(t.HTTPMETHOD.POST+r._oDraftMetadata.draftRootPreparationtionName+":before",{oXhr:a});r.fireEvent(t.HTTPMETHOD.POST+":before",{oXhr:a});var e=JSON.parse(a.requestBody);var o=[];for(var i in e){o.push(i+" eq "+e[i])}var s=jQuery.sap.sjax({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+o.join(" and "),dataType:"json"});if(!s.success||!s.data.d.results[0]){a.respond(404)}var n=s.data.d.results[0];r.fireEvent(t.HTTPMETHOD.POST+r._oDraftMetadata.draftRootPreparationtionName+":after",{oXhr:a,oEntry:n});r.fireEvent(t.HTTPMETHOD.POST+":after",{oXhr:a,oEntry:n});a.respondJSON(200,{},JSON.stringify({d:n}));return true}})}t.prototype.setRequests.apply(this,[e])},_generateMockdata:function(a,e){t.prototype._generateMockdata.apply(this,[a,e]);this._handleDraftArtifacts(a)},_loadMockdata:function(a,e){t.prototype._loadMockdata.apply(this,[a,e]);this._handleDraftArtifacts(a)},_resolveNavigation:function(a,e,r,o){var i=t.prototype._resolveNavigation.apply(this,[a,e,r,o]);if(r===this._oConstants.SIBLINGENTITY_NAVIGATION){if(o&&o.IsActiveEntity){i.splice(0,1)}else{i.length>1?i.splice(1,1):i.splice(0,1)}}else if(r===this._oConstants.DRAFT_ADMINISTRATIVE_DATA){if(o){if(o.IsActiveEntity&&!o.HasDraftEntity){i[0]=null}}else{i[0]=null}}return i},_findEntitySets:function(a){var e=t.prototype._findEntitySets.apply(this,[a]);this._prepareDraftMetadata(e);return e},getEntitySetData:function(a){var e=t.prototype.getEntitySetData.apply(this,[a]);var r=function(){return e};if(a===this._oDraftMetadata.draftRootName){this._fnDraftAdministrativeData({getParameter:r});return e}for(var o=0;o<this._oDraftMetadata.draftNodes.length;o++){if(a===this._oDraftMetadata.draftNodes[o]){this._fnDraftAdministrativeData({getParameter:r});return e}}return e}}},true);
//# sourceMappingURL=DraftEnabledMockServer.js.map