/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_ConcatHelper","./_GroupLock","./_Helper","./_MinMaxHelper","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,n,r,i,o,a,l){"use strict";function s(r,o,a,s,u){var c=function(){},d=null,f=this;t.call(this,r,o,s,true);this.oAggregation=a;this.sDownloadUrl=t.prototype.getDownloadUrl.call(this,"");this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.oLeavesPromise=undefined;if(s.$count&&a.groupLevels.length){s.$$leaves=true;this.oLeavesPromise=new l(function(e){d=function(t){e(parseInt(t.UI5__leaves))}})}this.oFirstLevel=this.createGroupLevelCache(null,u||!!d);this.oGrandTotalPromise=undefined;if(u){this.oGrandTotalPromise=new l(function(t){n.enhanceCache(f.oFirstLevel,a,[d,function(n){var r;if(a["grandTotal like 1.84"]){e.removeUI5grand__(n)}e.setAnnotations(n,true,true,0,e.getAllProperties(a));if(a.grandTotalAtBottomOnly===false){r=Object.assign({},n,{"@$ui5.node.isExpanded":undefined});i.setPrivateAnnotation(n,"copy",r);i.setPrivateAnnotation(r,"predicate","($isTotal=true)")}i.setPrivateAnnotation(n,"predicate","()");t(n)},c])})}else if(d){n.enhanceCache(f.oFirstLevel,a,[d,c])}}s.prototype=Object.create(t.prototype);s.prototype.addElements=function(e,t,n,r){var o=this.aElements;function a(e,a){var l=o[t+a],s,u=i.getPrivateAnnotation(e,"predicate");if(l){if(l===e){return}s=i.getPrivateAnnotation(l,"parent");if(!s){throw new Error("Unexpected element")}if(s!==n||i.getPrivateAnnotation(l,"index")!==r+a){throw new Error("Wrong placeholder")}}else if(t+a>=o.length){throw new Error("Array index out of bounds: "+(t+a))}if(u in o.$byPredicate&&o.$byPredicate[u]!==e){throw new Error("Duplicate predicate: "+u)}o[t+a]=e;o.$byPredicate[u]=e}if(t<0){throw new Error("Illegal offset: "+t)}if(Array.isArray(e)){e.forEach(a)}else{a(e,0)}};s.prototype.collapse=function(e){var t,n=0,o=this.aElements,a=this.fetchValue(r.$cached,e).getResult(),l=a["@$ui5.node.level"],s=o.indexOf(a),u=s+1;function c(e){delete o.$byPredicate[i.getPrivateAnnotation(o[e],"predicate")];n+=1}t=i.getPrivateAnnotation(a,"collapsed");i.updateAll(this.mChangeListeners,e,a,t);while(u<o.length&&o[u]["@$ui5.node.level"]>l){c(u);u+=1}if(this.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(t).length>1){c(u)}i.setPrivateAnnotation(a,"spliced",o.splice(s+1,n));o.$count-=n;return n};s.prototype.createGroupLevelCache=function(n,r){var o=this.oAggregation,a=e.getAllProperties(o),l,u,c,d,f,g;d=n?n["@$ui5.node.level"]+1:1;c=d>o.groupLevels.length;u=c?o.groupLevels.concat(Object.keys(o.group).sort()):o.groupLevels.slice(0,d);f=e.filterOrderby(this.mQueryOptions,o,d);g=!c&&Object.keys(o.aggregate).some(function(e){return o.aggregate[e].subtotals});if(n){f.$$filterBeforeAggregate=i.getPrivateAnnotation(n,"filter")+(f.$$filterBeforeAggregate?" and ("+f.$$filterBeforeAggregate+")":"")}if(!r){delete f.$count;f=e.buildApply(o,f,d)}f.$count=true;l=t.create(this.oRequestor,this.sResourcePath,f,true);l.calculateKeyPredicate=s.calculateKeyPredicate.bind(null,n,u,a,c,g);return l};s.prototype.expand=function(t,n){var o,a,s=this.aElements,u=typeof n==="string"?this.fetchValue(r.$cached,n).getResult():n,c,d=i.getPrivateAnnotation(u,"spliced"),f=this;if(n!==u){i.updateAll(this.mChangeListeners,n,u,e.getOrCreateExpandedObject(this.oAggregation,u))}if(d){i.deletePrivateAnnotation(u,"spliced");c=s.indexOf(u)+1;this.aElements=s.concat(d,s.splice(c));this.aElements.$byPredicate=s.$byPredicate;a=d.length;this.aElements.$count=s.$count+a;d.forEach(function(e){var t=i.getPrivateAnnotation(e,"predicate");if(t){f.aElements.$byPredicate[t]=e;if(i.getPrivateAnnotation(e,"expanding")){i.deletePrivateAnnotation(e,"expanding");a+=f.expand(r.$cached,e).getResult()}}});return l.resolve(a)}o=i.getPrivateAnnotation(u,"cache");if(!o){o=this.createGroupLevelCache(u);i.setPrivateAnnotation(u,"cache",o)}return o.read(0,this.iReadLength,0,t).then(function(t){var n=f.aElements.indexOf(u)+1,r=u["@$ui5.node.level"],l=i.getPrivateAnnotation(u,"collapsed"),s=f.oAggregation.subtotalsAtBottomOnly!==undefined&&Object.keys(l).length>1,c;if(!u["@$ui5.node.isExpanded"]){i.deletePrivateAnnotation(u,"spliced");return 0}if(!n){i.setPrivateAnnotation(u,"expanding",true);return 0}a=t.value.$count;if(s){a+=1}if(n===f.aElements.length){f.aElements.length+=a}else{for(c=f.aElements.length-1;c>=n;c-=1){f.aElements[c+a]=f.aElements[c];delete f.aElements[c]}}f.addElements(t.value,n,o,0);for(c=n+t.value.length;c<n+t.value.$count;c+=1){f.aElements[c]=e.createPlaceholder(r+1,c-n,o)}if(s){l=Object.assign({},l);e.setAnnotations(l,undefined,true,r,e.getAllProperties(f.oAggregation));i.setPrivateAnnotation(l,"predicate",i.getPrivateAnnotation(u,"predicate").slice(0,-1)+",$isTotal=true)");f.addElements(l,n+a-1)}f.aElements.$count+=a;return a},function(e){i.updateAll(f.mChangeListeners,n,u,i.getPrivateAnnotation(u,"collapsed"));throw e})};s.prototype.fetchValue=function(e,t,n,r){if(t==="$count"){if(this.oLeavesPromise){return this.oLeavesPromise}if(this.oAggregation.groupLevels.length){a.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return l.resolve()}return this.oFirstLevel.fetchValue(e,t,n,r)}this.registerChange(t,r);return this.drillDown(this.aElements,t,e)};s.prototype.getDownloadQueryOptions=function(t){return e.buildApply(this.oAggregation,e.filterOrderby(t,this.oAggregation),0,true)};s.prototype.getDownloadUrl=function(e,t){return this.sDownloadUrl};s.prototype.read=function(t,n,r,o,a){var s,u=t,c=n,d,f,g=!!this.oGrandTotalPromise,h=g&&this.oAggregation.grandTotalAtBottomOnly!==true,p=[],v,m,E=this;function $(e,t){var n=d,r=d.getQueryOptions(),l=i.getPrivateAnnotation(E.aElements[e],"index"),s=E.aElements[e];if(r.$count){delete r.$count;d.setQueryOptions(r,true)}p.push(d.read(l,t-e,0,o.getUnlockedCopy(),a).then(function(t){var r=false,i;if(s!==E.aElements[e]&&t.value[0]!==E.aElements[e]){r=true;e=E.aElements.indexOf(s);if(e<0){e=E.aElements.indexOf(t.value[0]);if(e<0){i=new Error("Collapse before read has finished");i.canceled=true;throw i}}}E.addElements(t.value,e,n,l);if(r){i=new Error("Collapse or expand before read has finished");i.canceled=true;throw i}}))}if(h&&!t&&n===1){if(r!==0){throw new Error("Unsupported prefetch length: "+r)}o.unlock();return this.oGrandTotalPromise.then(function(e){return{value:[e]}})}else if(this.aElements.$count===undefined){this.iReadLength=n+r;if(h){if(u){u-=1}else{c-=1}}p.push(this.oFirstLevel.read(u,c,r,o,a).then(function(t){var n,r,o=0,a;E.aElements.length=E.aElements.$count=t.value.$count;if(g){E.aElements.$count+=1;E.aElements.length+=1;n=E.oGrandTotalPromise.getResult();switch(E.oAggregation.grandTotalAtBottomOnly){case false:o=1;E.aElements.$count+=1;E.aElements.length+=1;E.addElements(n,0);r=i.getPrivateAnnotation(n,"copy");E.addElements(r,E.aElements.length-1);break;case true:E.addElements(n,E.aElements.length-1);break;default:o=1;E.addElements(n,0)}}E.addElements(t.value,u+o,E.oFirstLevel,u);for(a=0;a<E.aElements.$count;a+=1){if(!E.aElements[a]){E.aElements[a]=e.createPlaceholder(1,a-o,E.oFirstLevel)}}}))}else{for(v=t,m=Math.min(t+n,this.aElements.length);v<m;v+=1){s=i.getPrivateAnnotation(this.aElements[v],"parent");if(s!==d){if(f){$(f,v);d=f=undefined}if(s){f=v;d=s}}}if(f){$(f,v)}o.unlock()}return l.all(p).then(function(){var e=E.aElements.slice(t,t+n);e.$count=E.aElements.$count;return{value:e}})};s.prototype.refreshKeptElements=function(){};s.prototype.toString=function(){return this.sDownloadUrl};s.calculateKeyPredicate=function(t,n,r,o,a,l,s,u){var c;if(!(u in s)){return undefined}if(t){r.forEach(function(e){if(Array.isArray(e)){i.inheritPathValue(e,t,l)}else if(!(e in l)){l[e]=t[e]}})}c=o&&i.getKeyPredicate(l,u,s)||i.getKeyPredicate(l,u,s,n,true);i.setPrivateAnnotation(l,"predicate",c);if(!o){i.setPrivateAnnotation(l,"filter",i.getKeyFilter(l,u,s,n))}e.setAnnotations(l,o?undefined:false,a,t?t["@$ui5.node.level"]+1:1,t?null:r);return c};s.create=function(n,r,i,a,l,u,c){var d,f,g;if(a){d=e.hasGrandTotal(a.aggregate);f=!!a.groupLevels.length;g=e.hasMinOrMax(a.aggregate);if(d&&l.$filter&&!a["grandTotal like 1.84"]){throw new Error("Unsupported system query option: $filter")}if(f&&l.$filter){throw new Error("Unsupported system query option: $filter")}if(g){if(d){throw new Error("Unsupported grand totals together with min/max")}if(f){throw new Error("Unsupported group levels together with min/max")}}if(d||f||g){if("$expand"in l){throw new Error("Unsupported system query option: $expand")}if("$select"in l){throw new Error("Unsupported system query option: $select")}return g?o.createCache(n,r,a,l):new s(n,r,a,l,d)}}if(l.$$filterBeforeAggregate){l.$apply="filter("+l.$$filterBeforeAggregate+")/"+l.$apply;delete l.$$filterBeforeAggregate}return t.create(n,r,l,u,i,c)};return s},false);
//# sourceMappingURL=_AggregationCache.js.map