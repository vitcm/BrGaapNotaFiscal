/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/support/Plugin","sap/ui/core/support/controls/InteractionSlider","sap/ui/core/support/controls/InteractionTree","sap/ui/core/support/controls/TimelineOverview","sap/m/MessageToast","sap/ui/thirdparty/jszip","sap/ui/core/util/File","sap/ui/performance/trace/Interaction","sap/ui/performance/Measurement"],function(jQuery,t,e,r,i,n,s,a,o,p){"use strict";var c=t.extend("sap.ui.core.support.plugins.Interaction",{constructor:function(n){t.apply(this,["sapUiSupportInteraction","Interaction",n]);this._oStub=n;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetMeasurements",this.getId()+"SetActive",this.getId()+"Export",this.getId()+"Import",this.getId()+"SetQueryString"];var s=function(t,e){return("000"+String(t)).slice(-e)};this._fnFormatTime=function(t){var e=new Date(t),r=Math.floor((t-Math.floor(t))*1e3);return s(e.getHours(),2)+":"+s(e.getMinutes(),2)+":"+s(e.getSeconds(),2)+"."+s(e.getMilliseconds(),3)+s(r,3)};this._oInteractionSlider=new e;this._oInteractionTree=new r({});this._oTimelineOverview=new i}else{this._aEventIds=[this.getId()+"Refresh",this.getId()+"Clear",this.getId()+"Start",this.getId()+"Stop",this.getId()+"Activate",this.getId()+"Export",this.getId()+"Import",this.getId()+"SetQueryString"]}}});c.prototype.init=function(e){t.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){u.call(this,e)}else{d.call(this,e)}};c.prototype.exit=function(e){t.prototype.exit.apply(this,arguments)};function u(t){var e=sap.ui.getCore().createRenderManager();e.write('<div class="sapUiSupportToolbar">');e.write('<button id="'+this.getId()+'-record" class="sapUiSupportIntToggleRecordingBtn"></button>');e.write("<label class='sapUiSupportIntODataLbl'><input type='checkbox' id=\""+this.getId()+'-odata" > Enable OData Statistics</label>');e.write("<div class='sapUiSupportIntFupInputMask'>");e.write('<input id="'+this.getId()+"-fileImport\" tabindex='-1' size='1' accept='application/zip' type='file'>");e.write("</div>");e.write('<button id="'+this.getId()+'-import" class="sapUiSupportIntImportExportBtn sapUiSupportIntImportBtn sapUiSupportRoundedButton ">Import</button>');e.write('<button id="'+this.getId()+'-export" class="sapUiSupportIntImportExportBtn sapUiSupportIntExportBtn sapUiSupportRoundedButton sapUiSupportIntHidden ">Export</button>');e.write('<span id="'+this.getId()+'-info" class="sapUiSupportIntRecordingInfo"></span>');e.write('</div><div class="sapUiSupportInteractionCntnt">');e.write("</div>");e.write('<div class="sapUiPerformanceStatsDiv sapUiSupportIntHidden">');e.write('<div class="sapUiPerformanceTimeline" style="height: 50px;"></div>');e.write('<div class="sapUiPerformanceTop">');e.write("</div>");e.write('<div class="sapUiPerformanceBottom">');e.write("</div>");e.write("</div>");e.flush(this.$().get(0));e.destroy();e=sap.ui.getCore().createRenderManager();this._oTimelineOverview.render(e);e.flush(this.$().find(".sapUiPerformanceStatsDiv .sapUiPerformanceTimeline").get(0));e.destroy();e=sap.ui.getCore().createRenderManager();this._oInteractionSlider.render(e);e.flush(this.$().find(".sapUiPerformanceStatsDiv .sapUiPerformanceTop").get(0));e.destroy();this._oInteractionSlider._registerEventListeners();var r=this;jQuery(".sapUiPerformanceTop").on("InteractionSliderChange",{},function(t,e,i){r._oInteractionTree.setRange(e,i)});this.$("refresh").on("click",jQuery.proxy(function(t){this._oStub.sendEvent(this.getId()+"Refresh")},this));this.$("clear").on("click",jQuery.proxy(function(t){this._oStub.sendEvent(this.getId()+"Clear")},this));this.$("export").on("click",jQuery.proxy(function(t){this.onsapUiSupportInteractionExport()},this));this.$("fileImport").on("change",jQuery.proxy(function(t){this.onsapUiSupportInteractionImport()},this));this.$("active").on("click",jQuery.proxy(function(t){var e=false;if(this.$("active").prop("checked")){e=true}this._oStub.sendEvent(this.getId()+"Activate",{active:e})},this));this.$("odata").attr("checked",this._bODATA_Stats_On).on("click",jQuery.proxy(function(t){jQuery.sap.statistics(!jQuery.sap.statistics())},this));this.$("record").attr("data-state",!this._bFesrActive?"Start recording":"Stop recording");this.$("record").on("click",jQuery.proxy(function(t){if(this.$("record").attr("data-state")==="Stop recording"){this._oStub.sendEvent(this.getId()+"Refresh");this._oStub.sendEvent(this.getId()+"Activate",{active:false});this.$("record").attr("data-state","Start recording");jQuery(".sapUiPerformanceStatsDiv.sapUiSupportIntHidden").removeClass("sapUiSupportIntHidden");jQuery(".sapUiSupportIntExportBtn.sapUiSupportIntHidden").removeClass("sapUiSupportIntHidden")}else if(this.$("record").attr("data-state")==="Start recording"){jQuery(".sapUiPerformanceStatsDiv").addClass("sapUiSupportIntHidden");jQuery(".sapUiSupportIntExportBtn").addClass("sapUiSupportIntHidden");this._oStub.sendEvent(this.getId()+"Clear");this._oStub.sendEvent(this.getId()+"Activate",{active:true});this.$("record").attr("data-state","Stop recording")}},this))}function d(t){var e=/sap-ui-xx-fesr=(true|x|X)/.test(window.location.search);var r=jQuery.sap.statistics()||/sap-statistics=(true|x|X)/.test(window.location.search);this._oStub.sendEvent(this.getId()+"SetQueryString",{queryString:{bFesrActive:e,bODATA_Stats_On:r}});h.call(this)}function h(t,e){var r=o.getActive()||this._bFesrActive;var i=[];if(r||e){i=e||o.getAll(true);var n=window.performance.timing.fetchStart;for(var s=0;s<i.length;s++){var a=i[s];for(var p=0;p<a.requests.length;p++){var c=a.requests[p];a.requests[p]={connectEnd:c.connectEnd,connectStart:c.connectStart,domainLookupEnd:c.domainLookupEnd,domainLookupStart:c.domainLookupStart,duration:c.duration,entryType:c.entryType,fetchStart:c.fetchStart,initiatorType:c.initiatorType,name:c.name,redirectEnd:c.redirectEnd,redirectStart:c.redirectStart,requestStart:c.requestStart,responseEnd:c.responseEnd,responseStart:c.responseStart,secureConnectionStart:c.secureConnectionStart,startTime:c.startTime,workerStart:c.workerStart,fetchStartOffset:n}}}}this._oStub.sendEvent(this.getId()+"SetMeasurements",{measurements:i});this._oStub.sendEvent(this.getId()+"SetActive",{active:r})}c.prototype.onsapUiSupportInteractionSetQueryString=function(t){var e=t.getParameter("queryString");this._bFesrActive=e.bFesrActive;this._bODATA_Stats_On=e.bODATA_Stats_On;this.$("odata").attr("checked",this._bODATA_Stats_On);this.$("record").attr("data-state",!this._bFesrActive?"Start recording":"Stop recording")};c.prototype.onsapUiSupportInteractionSetMeasurements=function(t){this._setMeasurementsData(t.getParameter("measurements"))};c.prototype.onsapUiSupportInteractionSetActive=function(t){var e=t.getParameter("active");var r=this.$("active");if(e){r.attr("checked","checked")}else{r.removeAttr("checked")}};c.prototype.onsapUiSupportInteractionRefresh=function(t){h.call(this)};c.prototype.onsapUiSupportInteractionClear=function(t){o.clear();this._oStub.sendEvent(this.getId()+"SetMeasurements",{measurements:[]})};c.prototype.onsapUiSupportInteractionStart=function(t){p.start(this.getId()+"-perf","Measurement by support tool")};c.prototype.onsapUiSupportInteractionEnd=function(t){c.end(true)};c.prototype.onsapUiSupportInteractionActivate=function(t){var e=t.getParameter("active");if(o.getActive()!=e){o.setActive(e)}};c.prototype.onsapUiSupportInteractionExport=function(t){var e=this.measurements||[];if(e.length>0){var r=new s;r.file("InteractionsSteps.json",JSON.stringify(e).replace(/,"isExpanded":true/g,""));var i=r.generate({type:"blob"});this._openGeneratedFile(i)}};c.prototype.onsapUiSupportInteractionImport=function(t){var e=this.$().find("#"+this.getId()+"-fileImport").get(0).files;if(e.length===0){n.show("Select a file for import first!",{autoClose:true,duration:3e3});return}if(!window.FileReader){n.show("Use a modern browser which supports FileReader!",{autoClose:true,duration:3e3});return}var r=new window.FileReader,i=e[0],a=this;r.onload=function(t){return function(t){var e=new s(t.target.result);var r=e.files["InteractionsSteps.json"]&&e.files["InteractionsSteps.json"].asText();if(r){a._setMeasurementsData(JSON.parse(r.replace(/,"isExpanded":true/g,"")))}else{n.show("Imported data does not contain interaction measures",{autoClose:true,duration:3e3})}}}(i);r.readAsArrayBuffer(i)};c.prototype._openGeneratedFile=function(t){a.save(t,"InteractionSteps","zip","application/zip")};c.prototype._setMeasurementsData=function(t){var e=0,r=100,i=function(t){var e=function(t,e){var r=0;if(t.length===0){return r}for(var i=t.length-1;i>=0;i--){if(t[i].startTime<e.startTime){r=i+1;break}}return r},i=function(t,e){return t.filter(function(t){return t.timing.startTime===e})},n=function(t,e){var r=0;if(t.length===0){return r}for(var i=t.length-1;i>=0;i--){if(t[i].start<e.fetchStartOffset+e.startTime){r=i;break}}return r},s=0;t.forEach(function(t,a,o){var p=t.requests;for(var c=p.length-1;c>=0;c--){var u=p[c];if(a>0&&t.start-r>u.fetchStartOffset+u.startTime){var d=n(o,u);var h=o[d].requests;s=e(h,u);h.splice(s,0,u);p.splice(c,1);var l=i(t.sapStatistics,u.startTime);if(l.length>0){o[d].sapStatistics=o[d].sapStatistics.concat(l)}}}})};i(t);this.measurements=t;for(var n=0;n<t.length;n++){e+=t[n].requests.length}if(t.length>0){jQuery(".sapUiPerformanceStatsDiv.sapUiSupportIntHidden").removeClass("sapUiSupportIntHidden");jQuery(".sapUiSupportIntExportBtn.sapUiSupportIntHidden").removeClass("sapUiSupportIntHidden");this.$("info").text("Total "+e+" Requests in "+t.length+" Interactions")}else{jQuery(".sapUiPerformanceStatsDiv").addClass("sapUiSupportIntHidden");jQuery(".sapUiSupportIntExportBtn").addClass("sapUiSupportIntHidden");this.$("info").text("")}var s=this.$().find(".sapUiPerformanceStatsDiv .sapUiPerformanceTimeline").get(0);var a=sap.ui.getCore().createRenderManager();this._oTimelineOverview.setInteractions(t);this._oTimelineOverview.render(a);a.flush(s);a.destroy();this._oInteractionSlider._initSlider();this._oInteractionSlider.setDuration(t);var o=this.$().find(".sapUiPerformanceStatsDiv .sapUiPerformanceBottom").get(0);this._oInteractionTree.setInteractions(t);this._oInteractionTree.renderAt(o)};return c});
//# sourceMappingURL=Interaction.js.map