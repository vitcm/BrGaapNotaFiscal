/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/isEmptyObject","sap/ui/base/ManagedObject","sap/ui/core/Control","sap/ui/core/mvc/Controller","sap/base/util/merge","./ViewType","./ViewRenderer","./XMLProcessingMode","sap/base/assert","sap/base/Log","sap/base/util/extend","sap/ui/core/Core"],function(e,t,r,n,o,i,s,a,p,c,u){"use strict";var f=r.extend("sap.ui.core.mvc.View",{metadata:{interfaces:["sap.ui.core.IDScope"],abstract:true,library:"sap.ui.core",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},viewName:{type:"string",group:"Misc",defaultValue:null},displayBlock:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},events:{afterInit:{},beforeExit:{},afterRendering:{},beforeRendering:{}},specialSettings:{controller:"sap.ui.core.mvc.Controller",controllerName:"string",preprocessors:"Object",resourceBundleName:"string",resourceBundleUrl:"sap.ui.core.URI",resourceBundleLocale:"string",resourceBundleAlias:"string",type:"string",definition:"any",viewContent:{type:"any",deprecated:true},viewData:"any",async:{type:"boolean",defaultValue:false}},designtime:"sap/ui/core/designtime/mvc/View.designtime"},renderer:s});f._mPreprocessors={};function l(e){e._settings={};for(var t in e){if(t.indexOf("_")!==0){e._settings[t]=e[t]}}}function d(e,t){var r;if(typeof e.preprocessor==="string"){var n=e.preprocessor.replace(/\./g,"/");if(t){return new Promise(function(e,t){sap.ui.require([n],function(t){e(t)},t)})}else{return sap.ui.requireSync(n)}}else if(typeof e.preprocessor==="function"&&!e.preprocessor.process){r={process:e.preprocessor}}else{r=e.preprocessor}if(t){return Promise.resolve(r)}else{return r}}function g(e,t){var r=this.mPreprocessors[t]||[],n=[],o,i,s,a=[];if(f._mPreprocessors[e]&&f._mPreprocessors[e][t]){n=f._mPreprocessors[e][t].map(function(e){return Object.assign({},e)})}for(o=0,i=n.length;o<i;o++){if(n[o]._onDemand){s=n[o]}else{a.push(n[o])}}for(o=0,i=r.length;o<i;o++){var p=!r[o].preprocessor;if(p&&s){a.unshift(u(r[o],s))}else if(!p){a.push(r[o])}}return a}function m(e,t){var r=e.getMetadata().getClass();function n(e){e.preprocessor=d(e,t.async)}e.mPreprocessors=Object.assign({},t.preprocessors);for(var o in r.PreprocessorType){var i=r.PreprocessorType[o];if(e.mPreprocessors[i]&&!Array.isArray(e.mPreprocessors[i])){e.mPreprocessors[i]=[e.mPreprocessors[i]]}else if(!e.mPreprocessors[i]){e.mPreprocessors[i]=[]}e.mPreprocessors[i].forEach(l);e.mPreprocessors[i]=g.call(e,r._sType,i);e.mPreprocessors[i].forEach(n)}}function h(e){e.oAsyncState={};e.oAsyncState.promise=null}var y=function(e,r){if(!sap.ui.getCore().getConfiguration().getControllerCodeDeactivated()){var o=r.controller,i=o&&typeof o.getMetadata==="function"&&o.getMetadata().getName(),s=r.async;if(!o&&e.getControllerName){var a=e.getControllerName();if(a){var p=sap.ui.require("sap/ui/core/Component");if(p&&t._sOwnerId){var c=p.get(t._sOwnerId);if(c){var u=c;if(c.getExtensionComponent){u=c.getExtensionComponent();if(!u){throw new Error("getExtensionComponent() must return an instance.")}}var f=u._getManifestEntry("/sap.ui5/extends/extensions/sap.ui.controllerReplacements/"+a,true);if(f){a=typeof f==="string"?f:f.controllerName}}}if(s){o=n.create({name:a,_viewId:e.sId})}else{o=sap.ui.controller(a,true,false,e.sId)}}}else if(o){var l=t._sOwnerId;if(!o._isExtended()){o=n.applyExtensions(o,i,l,e.sId,s)}else if(s){o=Promise.resolve(o)}}if(o){var d=function(t){e.oController=t;t.oView=e};if(s){if(!e.oAsyncState){throw new Error("The view "+e.sViewName+" runs in sync mode and therefore cannot use async controller extensions!")}return o.then(d)}else{d(o)}}}else{sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl",{"_sap.ui.core.mvc.EmptyControllerImpl":true});e.oController=sap.ui.controller("sap.ui.core.mvc.EmptyControllerImpl")}};f.prototype._initCompositeSupport=function(t){t=t||{};p(!t.preprocessors||this.getMetadata().getName().indexOf("XMLView"),"Preprocessors only available for XMLView");this.oViewData=t.viewData;this.sViewName=t.viewName;if(this.sViewName&&this.sViewName.startsWith("module:")){this.sViewName=this.sViewName.slice("module:".length).replace(/\//g,".")}var r=this;m(this,t);if(t.async){h(this)}var n=sap.ui.require("sap/ui/core/Component");var o=n&&n.getOwnerComponentFor(this);if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()){if(o){var i=o;if(o.getExtensionComponent){i=o.getExtensionComponent();if(!i){throw new Error("getExtensionComponent() must return an instance.")}}var s=i._getManifestEntry("/sap.ui5/extends/extensions/sap.ui.viewModifications/"+this.sViewName,true);if(!e(s)){this._fnSettingsPreprocessor=function(e){var t=this.getId();if(t){if(r.isPrefixedId(t)){t=t.substring((r.getId()+"--").length)}var n=Object.assign({},s[t]);if(n){for(var o in n){if(o!=="visible"){c.warning("Customizing: custom value for property '"+o+"' of control '"+t+"' in View '"+r.sViewName+"' ignored: only the 'visible' property can be customized.");delete n[o]}}c.info("Customizing: custom value for property 'visible' of control '"+t+"' in View '"+r.sViewName+"' applied: "+n.visible);e=u(e,n)}}}}}}var a=function(e,t){p(typeof e==="function","fn must be a function");if(o){if(t){r.fnScopedRunWithOwner=r.fnScopedRunWithOwner||function(e){return o.runAsOwner(e)}}return o.runAsOwner(e)}return e()};var f=function(e){if(e.oController&&e.oController.connectToView){return e.oController.connectToView(e)}};var l=function(e){if(r.onControllerConnected){return r.onControllerConnected(r.oController,e)}};if(t.async){this.oAsyncState.promise=this.initViewSettings(t).then(function(){return a(y.bind(null,r,t),true)}).then(function(){return a(l.bind(null,t),true)}).then(function(){return f(r)}).then(function(){return r.runPreprocessor("controls",r,false)}).then(function(){return a(r.fireAfterInit.bind(r),true)}).then(function(){return r}).catch(function(e){this.deregister();throw e}.bind(this))}else{this.initViewSettings(t);y(this,t);l(t);f(this);this.runPreprocessor("controls",this,true);this.fireAfterInit()}};f.prototype.getController=function(){return this.oController};f.prototype.byId=function(e){return sap.ui.getCore().byId(this.createId(e))};f.prototype.createId=function(e){if(!this.isPrefixedId(e)){e=this.getId()+"--"+e}return e};f.prototype.getLocalId=function(e){var t=this.getId()+"--";return e&&e.indexOf(t)===0?e.slice(t.length):null};f.prototype.isPrefixedId=function(e){return!!(e&&e.indexOf(this.getId()+"--")===0)};f.prototype.getViewData=function(){return this.oViewData};function v(){this.oAsyncState=null}f.prototype.exit=function(){this.fireBeforeExit();delete this.oController;delete this.oPreprocessorInfo;if(this.oAsyncState){var e=v.bind(this);this.oAsyncState.promise.then(e,e)}};f.prototype.onAfterRendering=function(){this.fireAfterRendering()};f.prototype.onBeforeRendering=function(){this.fireBeforeRendering()};f.prototype.clone=function(e,t){var n={},o,i;for(o in this.mProperties&&!(this.isBound&&this.isBound(o))){if(this.mProperties.hasOwnProperty(o)){n[o]=this.mProperties[o]}}i=r.prototype.clone.call(this,e,t,{cloneChildren:false,cloneBindings:true});var s,a,p;for(s in i.mEventRegistry){a=i.mEventRegistry[s];for(p=a.length-1;p>=0;p--){if(a[p].oListener===this.getController()){a[p]={oListener:i.getController(),fFunction:a[p].fFunction,oData:a[p].oData}}}}i.applySettings(n);return i};f.prototype.getPreprocessors=function(){return this.mPreprocessors};f.prototype.getPreprocessorInfo=function(e){if(!this.oPreprocessorInfo){this.oPreprocessorInfo={name:this.sViewName,componentId:this._sOwnerId,id:this.getId(),caller:this+" ("+this.sViewName+")",sync:!!e}}if(f._supportInfo){this.oPreprocessorInfo._supportInfo=f._supportInfo}return this.oPreprocessorInfo};f.prototype.runPreprocessor=function(e,t,r){var n=this.getPreprocessorInfo(r),o=this.mPreprocessors&&this.mPreprocessors[e]||[],i,s,a;if(!r){s=function(e,t){return function(r){return t.preprocessor.then(function(n){return n.process(r,e,t._settings)})}};a=Promise.resolve(t)}for(var p=0,u=o.length;p<u;p++){if(r&&o[p]._syncSupport===true){i=o[p].preprocessor.process;t=i(t,n,o[p]._settings)}else if(!r){a=a.then(s(n,o[p]))}else{c.debug('Async "'+e+'"-preprocessor was skipped in sync view execution for '+this.getMetadata().getClass()._sType+"View",this.getId())}}return r?t:a};function w(e,t){if(!f._mPreprocessors[t]){f._mPreprocessors[t]={}}if(!f._mPreprocessors[t][e]){f._mPreprocessors[t][e]=[]}}function C(e,t){return f._mPreprocessors[e][t].some(function(e){return!!e._onDemand})}f.registerPreprocessor=function(e,t,r,n,o,i){if(typeof o!=="boolean"){i=o;o=false}if(t){w(e,r);if(o&&C(r,e)){c.error('Registration for "'+e+'" failed, only one on-demand-preprocessor allowed',this.getMetadata().getName());return}f._mPreprocessors[r][e].push({preprocessor:t,_onDemand:o,_syncSupport:n,_settings:i});c.debug("Registered "+(o?"on-demand-":"")+'preprocessor for "'+e+'"'+(n?" with syncSupport":""),this.getMetadata().getName())}else{c.error('Registration for "'+e+'" failed, no preprocessor specified',this.getMetadata().getName())}};f.prototype.hasPreprocessor=function(e){return!!this.mPreprocessors[e].length};f.create=function(e){var r=o({},e);r.async=true;r.viewContent=r.definition;var n=sap.ui.require("sap/ui/core/Component");var i;if(n&&t._sOwnerId){i=n.get(t._sOwnerId)}function s(){return P(r.id,r,r.type).loaded()}return new Promise(function(e,t){var n=I(r);sap.ui.require([n],function(t){e(t)},t)}).then(function(e){if(e.getMetadata().isA("sap.ui.core.mvc.XMLView")){r.processingMode=a.Sequential}if(i){return i.runAsOwner(s)}else{return s()}})};f._create=P;sap.ui.view=function(e,t,r){var n=typeof e==="string"?e:t;n=typeof n==="object"?n.viewName:n;c.warning("Do not use deprecated view factory functions (View: "+n+"). "+"Use the static create function on the view module instead: [XML|HTML|JSON]View.create().","sap.ui.view",null,function(){return{type:"sap.ui.view",name:n}});return P(e,t,r)};function P(e,r,n){var o=null,s={};if(typeof e==="object"||typeof e==="string"&&r===undefined){r=e;e=undefined}if(r){if(typeof r==="string"){s.viewName=r}else{s=r}}p(!s.async||typeof s.async==="boolean","sap.ui.view factory: Special setting async has to be of the type 'boolean'!");if(e){s.id=e}if(n){s.type=n}if(s.type===i.XML&&s.async){s.processingMode=s.processingMode||a.SequentialLegacy}if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()){var f=sap.ui.require("sap/ui/core/Component");var l;if(f&&t._sOwnerId){l=f.get(t._sOwnerId)}if(l){var d=l;if(l.getExtensionComponent){var d=l.getExtensionComponent();if(!d){throw new Error("getExtensionComponent() must return an instance.")}}var g=d._getManifestEntry("/sap.ui5/extends/extensions/sap.ui.viewReplacements/"+s.viewName,true);if(g){delete g.async;c.info("Customizing: View replacement for view '"+s.viewName+"' found and applied: "+g.viewName+" (type: "+g.type+")");u(s,g)}else{c.debug("Customizing: no View replacement found for view '"+s.viewName+"'.")}}}var m=I(s);o=b(m,s);return o}function I(e){var t=f._getModuleName(e);if(t){return t}if(!e.type){throw new Error("No view type specified.")}else if(e.type===i.JS){t="sap/ui/core/mvc/JSView"}else if(e.type===i.JSON){t="sap/ui/core/mvc/JSONView"}else if(e.type===i.XML){t="sap/ui/core/mvc/XMLView"}else if(e.type===i.HTML){t="sap/ui/core/mvc/HTMLView"}else if(e.type===i.Template){t="sap/ui/core/mvc/TemplateView"}else{throw new Error("Unknown view type "+e.type+" specified.")}return t}function b(e,t){var r=sap.ui.require(e);if(!r){r=sap.ui.requireSync(e);if(t.async){c.warning("sap.ui.view was called without requiring the according view class.")}}return new r(t)}f.prototype.loaded=function(){if(this.oAsyncState&&this.oAsyncState.promise){return this.oAsyncState.promise}else{return Promise.resolve(this)}};f._getModuleName=function(e){var t;if(e.viewName&&e.viewName.startsWith("module:")){t=e.viewName.slice("module:".length)}return t};f.prototype.getAutoPrefixId=function(){return false};f.prototype.onControllerConnected=function(e,r){if(!this.createContent&&typeof this.createContent!=="function"){return}var n={id:this.getAutoPrefixId()?this.createId.bind(this):undefined,settings:this._fnSettingsPreprocessor};return t.runWithPreprocessors(function(){if(r.async){var t=this.createContent(e);t=t instanceof Promise?t:Promise.resolve(t);return t.then(function(e){this.applySettings({content:e})}.bind(this))}else{this.applySettings({content:this.createContent(e)})}}.bind(this),n)};f.prototype.initViewSettings=function(e){if(!this.getMetadata()._oRenderer){this.getMetadata().getRenderer=function(){return f.getMetadata().getRenderer()};this.getMetadata().getRendererName=function(){return f.getMetadata().getRendererName()}}if(e.async){return Promise.resolve()}};return f});
//# sourceMappingURL=View.js.map