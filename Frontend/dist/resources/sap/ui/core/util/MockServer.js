/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","sap/ui/thirdparty/sinon","sap/base/Log","sap/base/util/isEmptyObject","jquery.sap.sjax"],function(jQuery,e,t,r,n){"use strict";var a=e.extend("sap.ui.core.util.MockServer",{constructor:function(t,r,n){e.apply(this,arguments);a._aServers.push(this)},metadata:{library:"sap.ui.core",properties:{rootUri:"string",recordRequests:{type:"boolean",defaultValue:true},requests:{type:"object[]",defaultValue:[]}}},_oServer:null,_aFilter:null,_oMockdata:null,_oMetadata:null,_sMetadataUrl:null,_sMockdataBaseUrl:null,_mEntitySets:null,_oErrorMessages:{INVALID_SYSTEM_QUERY_OPTION_VALUE:"Invalid system query options value",IS_NOT_A_VALID_SYSTEM_QUERY_OPTION:"## is not a valid system query option",URI_VIOLATING_CONSTRUCTION_RULES:"The URI is violating the construction rules defined in the Data Services specification",UNSUPPORTED_FORMAT_VALUE:"Unsupported format value. Only json format is supported",MALFORMED_SYNTAX:"The Data Services Request could not be understood due to malformed syntax",RESOURCE_NOT_FOUND:"Resource not found",INVALID_SORTORDER_DETECTED:"Invalid sortorder ## detected",PROPERTY_NOT_FOUND:"Property ## not found",INVALID_FILTER_QUERY_STATEMENT:"Invalid filter query statement",INVALID_FILTER_OPERATOR:"Invalid $filter operator ##",RESOURCE_NOT_FOUND_FOR_SEGMENT:"Resource not found for the segment ##",MALFORMED_URI_LITERAL_SYNTAX_IN_KEY:"Malformed URI literal syntax in key ##",INVALID_KEY_NAME:"Invalid key name in key predicate. Expected name is ##",INVALID_KEY_PREDICATE_QUANTITY:"Invalid key predicate. The quantity of provided keys does not match the expected value",INVALID_KEY_TYPE:"Invalid key predicate. The key literal for key property ## does not match its type."},_oRandomSeed:{}});a.prototype._getPseudoRandomNumber=function(e){if(!this._oRandomSeed){this._oRandomSeed={}}if(!this._oRandomSeed.hasOwnProperty(e)){this._oRandomSeed[e]=0}this._oRandomSeed[e]=(this._oRandomSeed[e]+11)*25214903917%0xffffffffffff;return this._oRandomSeed[e]/0xffffffffffff};a.prototype._resetPseudoRandomNumberGenerator=function(){this._oRandomSeed={}};a.prototype.start=function(){this._oServer=a._getInstance();this._aFilters=[];var e=this.getRequests();var t=this;e.forEach(function(e){var r;if(t.getRecordRequests()===false&&e.response){r=function(){e.response.apply(this,arguments);t._oServer.requests=[]}}else{r=e.response}t._addRequestHandler(e.method,e.path,r)})};a.prototype.stop=function(){if(this.isStarted()){this._removeAllRequestHandlers();this._removeAllFilters();this._oServer=null}};a.prototype.attachBefore=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":before",t)};a.prototype.attachAfter=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":after",t)};a.prototype.detachBefore=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":before",t)};a.prototype.detachAfter=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":after",t)};a.prototype.isStarted=function(){return!!this._oServer};a.prototype.getEntitySetData=function(e){var t=this;var n;if(this._oMockdata&&this._oMockdata.hasOwnProperty(e)){n=jQuery.extend(true,[],t._oMockdata[e])}else{r.error("Unrecognized EntitySet name: "+e)}return n};a.prototype.setEntitySetData=function(e,t){if(this._oMockdata&&this._oMockdata.hasOwnProperty(e)){this._oMockdata[e]=t}else{r.error("Unrecognized EntitySet name: "+e)}};a.prototype._applyQueryOnCollection=function(e,t,r,n){var a=t.split("=");var s=a[1];if(s===""){return}if(s.lastIndexOf(",")===s.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(a[0]){case"$top":if(!new RegExp(/^\d+$/).test(s)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(0,s);break;case"$skip":if(!new RegExp(/^\d+$/).test(s)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(s,e.results.length);break;case"$orderby":e.results=this._getOdataQueryOrderby(e.results,s,r);break;case"$filter":e.results=this._recursiveOdataQueryFilter(e.results,s);break;case"search-focus":break;case"search":var o="";for(var i=0;i<n.length;i++){if(n[i].indexOf("search-focus")!=-1){o=n[i].split("=")[1];break}}e.results=this._recursiveOdataQuerySearch(e.results,s,o,r);break;case"$select":e.results=this._getOdataQuerySelect(e.results,s,r);break;case"$inlinecount":var u=this._getOdataInlineCount(e.results,s);if(u){e.__count=u}break;case"$expand":e.results=this._getOdataQueryExpand(e.results,s,r);break;case"$format":e.results=this._getOdataQueryFormat(e.results,s);break;default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,a[0])}};a.prototype._applyQueryOnEntry=function(e,t,r){var n=t.split("=");var a=n[1];if(a===""){return}if(a.lastIndexOf(",")===a.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(n[0]){case"$filter":return this._recursiveOdataQueryFilter([e],a)[0];case"$select":return this._getOdataQuerySelect([e],a,r)[0];case"$expand":return this._getOdataQueryExpand([e],a,r)[0];case"$format":return this._getOdataQueryFormat([e],a);default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,n[0])}};a.prototype._getOdataQueryOrderby=function(e,t,r){var n=t.split(",");var a=this;jQuery.each(n,function(e,t){n[e]=a._trim(t)});var s=function e(t,s){for(var o=0;o<n.length;o++){var i=n[o].split(" ");var u=1;if(i.length>1){switch(i[1]){case"asc":u=1;break;case"desc":u=-1;break;default:a._logAndThrowMockServerCustomError(400,a._oErrorMessages.INVALID_SORTORDER_DETECTED,i[1])}}var f,c;var p=i[0].indexOf("/");if(p!==-1){f=i[0].substring(p+1);c=i[0].substring(0,p);if(!t[c].hasOwnProperty(f)){var d=false;var l=[];if(c){var h=a._mEntitySets[r].navprops[c].to.entitySet;l=a._mEntityTypes[a._mEntitySets[h].type].properties;for(var o=0;o<l.length;o++){if(l[o].name===f){d=true;break}}}if(!d){a._logAndThrowMockServerCustomError(400,a._oErrorMessages.PROPERTY_NOT_FOUND,f)}}if(t[c][f]<s[c][f]){return-1*u}if(t[c][f]>s[c][f]){return 1*u}}else{f=i[0];if(!t.hasOwnProperty(f)){a._logAndThrowMockServerCustomError(400,a._oErrorMessages.PROPERTY_NOT_FOUND,f)}if(t[f]<s[f]){return-1*u}if(t[f]>s[f]){return 1*u}}}return 0};return e.sort(s)};a.prototype._arrayUnique=function(e){var t=e.concat();for(var r=0;r<t.length;++r){for(var n=r+1;n<t.length;++n){if(t[r]===t[n]){t.splice(n--,1)}}}return t};a.prototype._getBracketIndices=function(e){var t=[];var r=0;var n,a=0;for(var s=0;s<e.length;s++){if(e[s]==="("){if(/[substringof|endswith|startswith]$/.test(e.substring(0,s))){++r}else{t.push(e[s]);if(n===undefined){n=s}}}else if(e[s]===")"){if(!r){t.pop();a=s;if(t.length===0){return{start:n,end:a}}}else{--r}}}return{start:n,end:a}};a.prototype._recursiveOdataQueryFilter=function(e,t){var r=this._getBracketIndices(t);if(r.start===0&&r.end===t.length-1){t=this._trim(t.substring(r.start+1,r.end));return this._recursiveOdataQueryFilter(e,t)}var n=/([^substringof|endswith|startswith]|^)\((.*)\)/,a,s;var o;if(n.test(t)){var i=t.substring(r.start,r.end+1);var u=new RegExp("(.*) +(or|and) +("+this._trim(this._escapeStringForRegExp(i))+".*)");if(r.start===0){u=new RegExp("("+this._trim(this._escapeStringForRegExp(i))+") +(or|and) +(.*)")}var f=u.exec(t);if(f===null){return this._getOdataQueryFilter(e,this._trim(t))}var c=f[1];o=f[2];var p=f[3];var d=this._recursiveOdataQueryFilter(e,c);if(o==="or"){a=this._recursiveOdataQueryFilter(e,p);return this._arrayUnique(d.concat(a))}if(o==="and"){return this._recursiveOdataQueryFilter(d,p)}}else{s=t.split(/ +and | or +/);if(s.length===1){return this._getOdataQueryFilter(e,this._trim(t))}var l=this._recursiveOdataQueryFilter(e,s[0]);var h;for(var v=1;v<s.length;v++){h=new RegExp(this._trim(this._escapeStringForRegExp(s[v-1]))+" +(and|or) +"+this._trim(this._escapeStringForRegExp(s[v])));o=h.exec(t)[1];if(o==="or"){a=this._recursiveOdataQueryFilter(e,s[v]);l=this._arrayUnique(l.concat(a))}if(o==="and"){l=this._recursiveOdataQueryFilter(l,s[v])}}return l}};a.prototype._getOdataQueryFilter=function(e,t){if(e.length===0){return e}var n=new RegExp("(.*) (eq|ne|gt|lt|le|ge) (.*)");var a=new RegExp("(endswith|startswith|substringof)\\((.*)");var s=null;var o=n.exec(t);if(o){s=o[2]}else{o=a.exec(t);if(o){s=o[1]}else{this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_FILTER_QUERY_STATEMENT)}}var i=this;var u=function(a,s,o,u){var f,c,p;if(!a){f=n.exec(t);c=i._trim(f[s+1]);p=i._trim(f[o+1])}else{var d=new RegExp("(substringof|startswith|endswith)\\(([^\\)]*),(.*)\\)");f=d.exec(t);c=i._trim(f[s+2]);p=i._trim(f[o+2])}if(/^\(.+\)$/.test(c)){c=c.replace(/^\(|\)$/g,"")}var l=c[c.length-1];if(l==="M"||l==="m"||l==="L"||l==="f"){c=c.substring(0,c.length-1)}if(c.indexOf("datetime")===0){c=i._getJsonDate(c)}else if(c.indexOf("guid")===0){c=c.substring(5,c.length-1)}else if(c==="true"){c=true}else if(c==="false"){c=false}else if(i._isValidNumber(c)){c=parseFloat(c)}else if(c.charAt(0)==="'"&&c.charAt(c.length-1)==="'"){c=c.substr(1,c.length-2)}var h=p.indexOf("/");if(h!==-1){var v=p.substring(h+1);var _=p.substring(0,h);if(e[0][_]){if(!e[0][_].hasOwnProperty(v)){var E=i._oErrorMessages.PROPERTY_NOT_FOUND.replace("##","'"+v+"'");r.error("MockServer: navigation property '"+_+"' was not expanded, so "+E);return e}}else{i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,p)}return u(p,c,_,v)}else{if(!e[0].hasOwnProperty(p)){i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,p)}return u(p,c)}};switch(s){case"substringof":return u(true,0,1,function(t,r,n,a){return e.filter(function(e){if(n&&a){return typeof e[n][a]==="string"&&e[n][a].indexOf(r)!==-1}return typeof e[t]==="string"&&e[t].indexOf(r)!==-1})});case"startswith":return u(true,1,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return typeof e[n][a]==="string"&&e[n][a].indexOf(r)===0}return typeof e[t]==="string"&&e[t].indexOf(r)===0})});case"endswith":return u(true,1,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return typeof e[n][a]==="string"&&e[n][a].indexOf(r)===e[n][a].length-r.length}return typeof e[t]==="string"&&e[t].indexOf(r)===e[t].length-r.length})});case"eq":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]===r}return e[t]===r})});case"ne":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]!==r}return e[t]!==r})});case"gt":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]>r}return e[t]>r})});case"lt":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]<r}return e[t]<r})});case"ge":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]>=r}return e[t]>=r})});case"le":return u(false,2,0,function(t,r,n,a){return e.filter(function(e){if(n&&a){return e[n][a]<=r}return e[t]<=r})});default:this._logAndThrowMockServerCustomError(400,i._oErrorMessages.INVALID_FILTER_OPERATOR,s)}};a.prototype._recursiveOdataQuerySearch=function(e,t,r,n){var a="";if(r==""||r==undefined){for(var s=0;s<this._mEntitySets[n].keys.length;s++){if(s!=0){a=a+" or "}a=a+"startswith("+this._mEntitySets[n].keys[s]+",'"+t+"')"}}else{a="substringof('"+t+"',"+r+")"}return this._recursiveOdataQueryFilter(e,a)};a.prototype._getOdataQuerySelect=function(e,t,r){var n=this;var a,s;var o=t.split(",");var i=[];var u;var f=e[0]?e[0][o[0].split("/")[0]]:null;if(!(f!=null&&f.results&&f.results.length>0)){var c=function(e,t,o,i){var u={};jQuery.each(e,function(e,t){var r=t.indexOf("/");if(r!==-1){a=t.substring(r+1);s=t.substring(0,r);if(u[s]){u[s].push(a)}else{u[s]=[a]}}});jQuery.each(Object.keys(u),function(e,r){if(!o[r]){o[r]={}}o[r]=c(u[r],t[r],o[r],r)});if(t.results){var f=[];jQuery.each(t.results,function(t,r){var n={};jQuery.each(e,function(e,t){n[t]=r[t]});f.push(n)});if(o){o.results=f}}else{if(t["__metadata"]){o["__metadata"]=t["__metadata"]}jQuery.each(e,function(e,a){var s=a.indexOf("/");if(s===-1){if(t&&!t.hasOwnProperty(a)){var u=false;var f=[];if(i){var c=n._mEntitySets[r].navprops[i].to.entitySet;f=n._mEntityTypes[n._mEntitySets[c].type].properties;for(var e=0;e<f.length;e++){if(f[e].name===a){u=true;break}}}if(!u){n._logAndThrowMockServerCustomError(404,n._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,a)}}o[a]=t[a]}})}return o};if(o.indexOf("*")!==-1){return e}jQuery.each(o,function(e,t){o[e]=n._trim(t)});jQuery.each(e,function(e,t){u={};i.push(c(o,t,u))})}else{var p=function(e,t,r){var n={};r=r||"";if(typeof e!=="object"){return e}if(typeof e.slice==="function"){return e.map(function(e,n){return p(e,t,r)})}if(e.__metadata!==undefined&&r.length===0){n.__metadata=e.__metadata}t.filter(function(e){return(e+"/").indexOf(r)===0}).forEach(function(t,a,s){var o=t.substr(r.length).split("/")[0];if(e[o]!==undefined){n[o]=p(e[o],s,r+o+"/")}});if(e.results!==undefined){n.results=p(e.results,t,r)}return n};i=p(e,o)}return i};a.prototype._getOdataInlineCount=function(e,t){var r=t.split(",");if(r.length!==1||r[0]!=="none"&&r[0]!=="allpages"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}if(r[0]==="none"){return}return e.length};a.prototype._getOdataQueryFormat=function(e,t){if(t!=="json"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.UNSUPPORTED_FORMAT_VALUE)}return e};a.prototype._getOdataQueryExpand=function(e,t,r){var n=this;var a=t.split(",");jQuery.each(a,function(e,t){a[e]=n._trim(t)});var s=n._mEntitySets[r].navprops;jQuery.each(e,function(e,t){jQuery.each(a,function(e,a){var o=a.split("/");var i=o[0];if(!t[i]){n._logAndThrowMockServerCustomError(404,n._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,i)}var u=t[i].results||t[i];if(!u||u.__deferred){u=jQuery.extend(true,[],n._resolveNavigation(r,t,i,t))}else if(!Array.isArray(u)){u=[u]}if(u&&o.length>1){var f=o.splice(1,o.length).join("/");u=n._getOdataQueryExpand(u,f,s[i].to.entitySet)}if(s[i].to.multiplicity==="*"){t[i]={results:u}}else{t[i]=u[0]?u[0]:{}}})});return e};a.prototype._refreshData=function(){var e=this._loadMetadata(this._sMetadataString);if(!e){return}this._mEntitySets=this._findEntitySets(this._oMetadata);this._mEntityTypes=this._findEntityTypes(this._oMetadata);if(!this._sMockdataBaseUrl){this._generateMockdata(this._mEntitySets,this._oMetadata)}else{if(!this._sMockdataBaseUrl.endsWith("/")&&!this._sMockdataBaseUrl.endsWith(".json")){this._sMockdataBaseUrl+="/"}this._loadMockdata(this._mEntitySets,this._sMockdataBaseUrl)}};a.prototype._getRootUri=function(){var e=this.getRootUri();e=e&&/([^?#]*)([?#].*)?/.exec(e)[1];return e};a.prototype._loadMetadata=function(e){var e;e=e.trim();if(e.substring(0,1)!=="<"){e=jQuery.sap.sjax({url:e,dataType:"text"}).data;if(!e){r.error('MockServer: The metadata for url "'+e+'" could not be found!')}}this._sMetadata=e;try{this._oMetadata=jQuery.parseXML(e)}catch(e){r.error("MockServer: Invalid metadata XML! Reason: "+e)}return this._oMetadata};a.prototype._findEntitySets=function(e){var t={};var r=jQuery(e).find("Principal");var n=jQuery(e).find("Dependent");jQuery(e).find("EntitySet").each(function(e,r){var n=jQuery(r);var a=/((.*)\.)?(.*)/.exec(n.attr("EntityType"));t[n.attr("Name")]={name:n.attr("Name"),schema:a[2],type:a[3],keys:[],keysType:{},navprops:{}}});var a=function(e,t,a,s){var o=jQuery(a).find("End[Role='"+e+"']").attr("EntitySet");var i=jQuery(t).find("End[Role='"+e+"']").attr("Multiplicity");var u=[];var f=jQuery(t).find("ReferentialConstraint > [Role='"+e+"']");if(f&&f.length>0){jQuery(f[0]).children("PropertyRef").each(function(e,t){u.push(jQuery(t).attr("Name"))})}else{var c=s?r:n;jQuery(c).each(function(t,r){if(e===jQuery(r).attr("Role")){jQuery(r).children("PropertyRef").each(function(e,t){u.push(jQuery(t).attr("Name"))});return false}})}return{role:e,entitySet:o,propRef:u,multiplicity:i}};jQuery.each(t,function(t,r){var n=jQuery(e).find("EntityType[Name='"+r.type+"']");var s=jQuery(n).find("PropertyRef");jQuery.each(s,function(e,t){var a=jQuery(t).attr("Name");r.keys.push(a);r.keysType[a]=jQuery(n).find("Property[Name='"+a+"']").attr("Type")});var o=jQuery(e).find("EntityType[Name='"+r.type+"'] NavigationProperty");jQuery.each(o,function(t,n){var s=jQuery(n);var o=s.attr("Relationship").split(".");var i=jQuery(e).find("AssociationSet[Association = '"+o.join(".")+"']");var u=o.pop();var f=jQuery(e).find("Association[Name = '"+u+"']");r.navprops[s.attr("Name")]={name:s.attr("Name"),from:a(s.attr("FromRole"),f,i,true),to:a(s.attr("ToRole"),f,i,false)}})});return t};a.prototype._findEntityTypes=function(e){var t={};jQuery(e).find("EntityType").each(function(e,r){var n=jQuery(r);t[n.attr("Name")]={name:n.attr("Name"),properties:[],keys:[]};n.find("Property").each(function(e,r){var a=jQuery(r);var s=a.attr("Type");t[n.attr("Name")].properties.push({schema:s.substring(0,s.lastIndexOf(".")),type:s.substring(s.lastIndexOf(".")+1),name:a.attr("Name"),precision:a.attr("Precision"),scale:a.attr("Scale")})});n.find("PropertyRef").each(function(e,r){var a=jQuery(r);var s=a.attr("Name");t[n.attr("Name")].keys.push(s)})});return t};a.prototype._findComplexTypes=function(e){var t={};jQuery(e).find("ComplexType").each(function(e,r){var n=jQuery(r);t[n.attr("Name")]={name:n.attr("Name"),properties:[]};n.find("Property").each(function(e,r){var a=jQuery(r);var s=a.attr("Type");t[n.attr("Name")].properties.push({schema:s.substring(0,s.lastIndexOf(".")),type:s.substring(s.lastIndexOf(".")+1),name:a.attr("Name"),precision:a.attr("Precision"),scale:a.attr("Scale")})})});return t};a.prototype._createKeysString=function(e,t){var r=this;var n="";if(t){jQuery.each(e.keys,function(a,s){if(n){n+=","}var o=t[s];if(e.keysType[s]==="Edm.String"){o=encodeURIComponent("'"+o+"'")}else if(e.keysType[s]==="Edm.DateTime"){o=r._getDateTime(o);o=encodeURIComponent(o)}else if(e.keysType[s]==="Edm.Guid"){o="guid'"+o+"'"}if(e.keys.length===1){n+=o;return n}n+=s+"="+o})}return n};a.prototype._loadMockdata=function(e,t){var n=this,a={};this._oMockdata={};var s=function(e,t){var n=jQuery.sap.sjax({url:e,dataType:"json"});if(n.success){if(n.data.d){if(n.data.d.results){a[t.name]=n.data.d.results}else{r.error('The mock data format for entity set "'+t.name+'" invalid')}}else{if(Array.isArray(n.data)){a[t.name]=n.data}else{r.error('The mock data for entity set "'+t.name+'" could not be loaded due to wrong format!');return false}}return true}else{if(n.status==="parsererror"){r.error('The mock data for entity set "'+t.name+'" could not be loaded due to a parsing error!')}return false}};if(t.endsWith(".json")){var o=jQuery.sap.sjax({url:t,dataType:"json"});if(o.success){a=o.data}else{r.warning('The mock data for all the entity types could not be found at "'+t+'"!')}}else{var i={};if(n._aEntitySetsNames&&n._aEntitySetsNames.length>0){var u;for(var f=0;f<n._aEntitySetsNames.length;f++){u=n._aEntitySetsNames[f];if(e[u]){i[u]=e[u]}}}else{i=e}jQuery.each(i,function(e,o){if(!a[o.type]||!a[o.name]){var i=t+o.name+".json";if(!s(i,o)){r.warning('The mock data for entity set "'+o.name+'" could not be found at "'+t+'"!');var u=t+o.type+".json";if(!s(u,o)){r.warning('The mock data for entity type "'+o.type+'" could not be found at "'+t+'"!');if(n._bGenerateMissingMockData){var f={};f[o.name]=o;a[o.type]=n._generateODataMockdataForEntitySet(f,n._oMetadata)[o.name]}}}}})}jQuery.each(e,function(e,t){n._oMockdata[e]=[];if(a[t.name]){jQuery.each(a[t.name],function(t,r){n._oMockdata[e].push(jQuery.extend(true,{},r))})}else if(a[t.type]){jQuery.each(a[t.type],function(t,r){n._oMockdata[e].push(jQuery.extend(true,{},r))})}});jQuery.each(e,function(e,t){if(n._oMockdata[e].length>0){n._enhanceWithMetadata(t,n._oMockdata[e])}});return this._oMockdata};a.prototype._enhanceWithMetadata=function(e,t){if(t){var r=this,a=this._getRootUri(),s=e&&e.name;jQuery.each(t,function(t,o){o.__metadata=o.__metadata||{};o.__metadata.id=a+s+"("+r._createKeysString(e,o)+")";o.__metadata.type=e.schema+"."+e.type;o.__metadata.uri=a+s+"("+r._createKeysString(e,o)+")";jQuery.each(e.navprops,function(t,i){if(o[t]&&!n(o[t])&&!o[t]["__deferred"]){r._oMockdata[i.to.entitySet]=r._oMockdata[i.to.entitySet].concat(o[t])}o[t]={__deferred:{uri:a+s+"("+r._createKeysString(e,o)+")/"+t}}})})}};a.prototype._isRequestedKeysValid=function(e,t){if(t.length===1){var r=t[0].split("=");if(this._trim(r[0])!==e.keys[0]){t=[e.keys[0]+"="+t[0]]}}for(var n=0;n<t.length;n++){var a=this._trim(t[n].substring(0,t[n].indexOf("=")));var s=this._trim(t[n].substring(t[n].indexOf("=")+1));var o=s.charAt(0);var i=s.charAt(s.length-1);if(e.keysType[a]==="Edm.String"){if(o!=="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,a)}}else if(e.keysType[a]==="Edm.DateTime"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,a)}}else if(e.keysType[a]==="Edm.Guid"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,a)}}else if(e.keysType[a]==="Edm.Binary"){if(!new RegExp("(binary|X)'[A-Fa-f0-9][A-Fa-f0-9]*'").test(s)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,a)}}else{if(o==="'"&&i!=="'"||i==="'"&&o!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,a)}}var u=e.keys.join(",");if(e.keys.indexOf(a)===-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_KEY_NAME,u)}}};a.prototype._parseKeys=function(e,t){var r={};var n=e.split(",");var a,s,o;for(var i=0;i<n.length;i++){o=n[i].split("=");if(o.length===1&&t.keys.length===1){a=t.keys[0];s=o[0]}else{if(o.length===2){a=o[0];s=o[1]}}r[a]=s;switch(t.keysType[a]){case"Edm.String":r[a]=r[a].replace(/^\'|\'$/g,"");break;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":r[a]=parseFloat(r[a]);break;case"Edm.Guid":r[a]=r[a].replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":case"Edm.Binary":case"Edm.DateTimeOffset":default:}}return r};a.prototype._generatePropertyValue=function(e,t,r,n){var a=n;if(!a){a=Math.floor(this._getPseudoRandomNumber("String")*1e4)+101}switch(t){case"String":return e+" "+a;case"DateTime":var s=new Date;s.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTime")*20));s.setDate(Math.floor(this._getPseudoRandomNumber("DateTime")*30));s.setMonth(Math.floor(this._getPseudoRandomNumber("DateTime")*12));s.setMilliseconds(0);return"/Date("+s.getTime()+")/";case"Int16":case"Int32":case"Int64":return Math.floor(this._getPseudoRandomNumber("Int")*1e4);case"Decimal":return Math.floor(this._getPseudoRandomNumber("Decimal")*1e6)/100;case"Boolean":return this._getPseudoRandomNumber("Boolean")<.5;case"Byte":return Math.floor(this._getPseudoRandomNumber("Byte")*10);case"Double":return this._getPseudoRandomNumber("Double")*10;case"Single":return this._getPseudoRandomNumber("Single")*1e9;case"SByte":return Math.floor(this._getPseudoRandomNumber("SByte")*10);case"Time":return"PT"+Math.floor(this._getPseudoRandomNumber("Time")*23)+"H"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"M"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"S";case"Guid":return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=this._getPseudoRandomNumber("Guid")*16|0,r=e==="x"?t:t&3|8;return r.toString(16)}.bind(this));case"Binary":var o=Math.floor(-2147483648+this._getPseudoRandomNumber("Binary")*4294967295),i="";for(var u=0,f=o;u<32;u++,i+=String(f>>>31),f<<=1);return i;case"DateTimeOffset":var s=new Date;s.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*20));s.setDate(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*30));s.setMonth(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*12));s.setMilliseconds(0);return"/Date("+s.getTime()+"+0000)/";default:return this._generateDataFromEntity(r[t],a,r)}};a.prototype._isFalseyValue=function(e,t,r){switch(r){case"Edm.String":return e==="";case"Edm.Boolean":return e===false;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":return e===0||isNaN(e);default:return false}};a.prototype._completeKey=function(e,t,r){if(r){for(var n=0;n<e.keys.length;n++){var a=e.keys[n];if(t[a]!==undefined&&t[a]!==null){if(!r[a]){switch(e.keysType[a]){case"Edm.DateTime":r[a]=this._getJsonDate(t[a]);break;case"Edm.Guid":r[a]=t[a].replace(/^guid\'|\'$/g,"");break;default:r[a]=t[a]}}}else{if(!r[a]){r[a]=this._generatePropertyValue(a,e.keysType[a].substring(e.keysType[a].lastIndexOf(".")+1))}}}}};a.prototype._generateDataFromEntity=function(e,t,r){var n={};if(!e){return n}for(var a=0;a<e.properties.length;a++){var s=e.properties[a];n[s.name]=this._generatePropertyValue(s.name,s.type,r,t)}return n};a.prototype._generateDataFromEntitySet=function(e,t,r){var n=t[e.type];var a=[];for(var s=0;s<100;s++){a.push(this._generateDataFromEntity(n,s+1,r))}return a};a.prototype._generateMockdata=function(e,t){var r=this;var n={};var a=this._getRootUri();jQuery.each(e,function(e,a){var s={};s[a.name]=a;n[e]=r._generateODataMockdataForEntitySet(s,t)[e]});jQuery.each(e,function(e,t){for(var s in t.navprops){var o=t.navprops[s];var i=o.from.propRef.length;for(var u=0;u<i;u++){for(var f=0;f<n[e].length;f++){var c=n[e][f];n[o.to.entitySet][f][o.to.propRef[u]]=c[o.from.propRef[u]]}}}jQuery.each(n[e],function(n,s){s.__metadata={uri:a+e+"("+r._createKeysString(t,s)+")",type:t.schema+"."+t.type};jQuery.each(t.navprops,function(n,o){s[n]={__deferred:{uri:a+e+"("+r._createKeysString(t,s)+")/"+n}}})})});this._oMockdata=n};a.prototype._generateODataMockdataForEntitySet=function(e,t){var r=this,n={};var a=this._findEntityTypes(t);var s=this._findComplexTypes(t);jQuery.each(e,function(e,t){n[e]=r._generateDataFromEntitySet(t,a,s)});return n};a.prototype._resolveNavigation=function(e,t,r){var n=this._mEntitySets[e];var a=n.navprops[r];if(!a){this._logAndThrowMockServerCustomError(404,this._oErrorMessages.RESOURCE_NOT_FOUND)}var s=[];var o=a.from.propRef.length;if(o===0){if(a.to.multiplicity==="*"){return this._oMockdata[a.to.entitySet]}else{s.push(this._oMockdata[a.to.entitySet][0]);return s}}jQuery.each(this._oMockdata[a.to.entitySet],function(e,r){var n=true;for(var i=0;i<o;i++){if(t[a.from.propRef[i]]!==r[a.to.propRef[i]]){n=false;break}}if(n){s.push(r)}});return s};a.prototype.simulate=function(e,t){var s=this;this._sMetadataString=e;if(!t||typeof t==="string"){this._sMockdataBaseUrl=t}else{this._sMockdataBaseUrl=t.sMockdataBaseUrl;this._bGenerateMissingMockData=t.bGenerateMissingMockData;this._aEntitySetsNames=t.aEntitySetsNames}var o=this._loadMetadata(this._sMetadataString);if(!o){return}if(this._sMetadata){var i=sap.ui.requireSync("sap/ui/core/util/MockServerAnnotationsHandler");var u=i.parse(this._oMetadata,this._sMetadata);var f=sap.ui.requireSync("sap/ui/core/util/DraftEnabledMockServer");f.handleDraft(u,this)}this._resetPseudoRandomNumberGenerator();this._refreshData();var c=function(e,t){if(e.requestHeaders["x-csrf-token"]==="Fetch"){t["X-CSRF-Token"]="42424242424242424242424242424242"}};var p=function(e,t){t=decodeURIComponent(t);var r;var n=s._mEntitySets[e];var a=n.keys;var o=t.split(",");if(o.length!==a.length){s._logAndThrowMockServerCustomError(400,s._oErrorMessages.INVALID_KEY_PREDICATE_QUANTITY)}s._isRequestedKeysValid(n,o);if(o.length===1&&!o[0].split("=")[1]){o=[a[0]+"="+o[0]]}jQuery.each(s._oMockdata[e],function(e,t){for(var i=0;i<o.length;i++){var u=o[i].split("=");var f=s._trim(u[0]);if(!a||a.indexOf(f)===-1){return true}var c=s._trim(u[1]);var p=t[f];switch(n.keysType[f]){case"Edm.String":c=c.replace(/^\'|\'$/g,"");break;case"Edm.Time":case"Edm.DateTime":p=s._getDateTime(p);break;case"Edm.Int16":case"Edm.Int32":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":if(!s._isValidNumber(c)){return false}c=parseFloat(c);break;case"Edm.Guid":c=c.replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":if(["true","false"].indexOf(c)===-1){s._logAndThrowMockServerCustomError(400,s._oErrorMessages.INVALID_KEY_TYPE,f)}c=c==="true";break;case"Edm.Binary":case"Edm.DateTimeOffset":default:}if(p!==c){return true}}r={index:e,entry:t};return false});return r};var d=function(e,t,r){var n=e.name;var a;if(r){a=e.navprops[r]}if(a){n=a.to.entitySet}return n};var l=function(e){var t=[];var r=function(e){var t=e.indexOf("'");var r=e.indexOf('"');if(t===-1&&r===-1){return null}else{if(t>-1&&r===-1){return"appost"}if(r>-1&&t===-1){return"doublequotes"}if(t>-1&&r>-1&&t<r){return"appost"}if(t>-1&&r>-1&&r<t){return"doublequotes"}}};var n=function(e,t,r,n){var a=e[r];var s=r+1;while(s<e.length&&e[s].indexOf(n)===-1){a=a+"&"+e[s];s++}a=a+"&"+e[s];t.push(a);r=s;return r};for(var a=0;a<e.length;a++){if(!r(e[a])){t.push(e[a])}if(r(e[a])==="appost"){var s=e[a].indexOf("'");if(e[a].indexOf("'",s+1)===-1){a=n(e,t,a,"'")}else{t.push(e[a])}}if(r(e[a])==="doublequotes"){var o=e[a].indexOf('"');if(e[a].indexOf('"',o+1)===-1){a=n(e,t,a,'"')}else{t.push(e[a])}}}return t};var h=function(e,t,r,n){r=r?decodeURIComponent(r):r;var a=JSON.parse(e.requestBody);if(a){var o={};if(r){o=s._parseKeys(r,s._mEntitySets[t])}s._completeKey(s._mEntitySets[t],o,a);s._enhanceWithMetadata(s._mEntitySets[t],[a]);return a}return null};var v=[];v.push({method:"GET",path:new RegExp("\\$metadata([?#].*)?"),response:function(e){sap.ui.requireSync("jquery.sap.xml");r.debug("MockServer: incoming request for url: "+e.url);var t={"Content-Type":"application/xml;charset=utf-8"};c(e,t);e.respond(200,t,s._sMetadata);r.debug("MockServer: response sent with: 200, "+s._sMetadata);return true}});v.push({method:"HEAD",path:new RegExp("$"),response:function(e){r.debug("MockServer: incoming request for url: "+e.url);var t={"Content-Type":"application/json;charset=utf-8"};c(e,t);e.respond(200,t);r.debug("MockServer: response sent with: 200");return true}});v.push({method:"GET",path:new RegExp("$"),response:function(e){r.debug("MockServer: incoming request for url: "+e.url);var t={"Content-Type":"application/json;charset=utf-8"};c(e,t);var n=[];jQuery.each(s._mEntitySets,function(e,t){n.push(e)});var a={EntitySets:n};e.respond(200,t,JSON.stringify({d:a}));r.debug("MockServer: response sent with: 200, "+JSON.stringify({d:a}));return true}});v.push({method:"POST",path:new RegExp("\\$batch([?#].*)?"),response:function(e){r.debug("MockServer: incoming request for url: "+e.url);var t=function(e){switch(e.statusCode){case 200:return"200 OK";case 201:return"201 Created";case 204:return"204 No Content";case 400:return"400 Bad Request";case 401:return"401 Unauthorized";case 403:return"403 Forbidden";case 404:return"404 Not Found";case 405:return"405 Method Not Allowed";case 409:return"409 Conflict";case 412:return"412 Precondition Failed";case 415:return"415 Unsupported Media Type";case 500:return"500 Internal Server Error";case 501:return"501 Not Implemented";case 503:return"503 Service Unavailable";default:return e.statusCode+" "+e.status}};var n=function(e,r){var n;if(e.success){n=JSON.stringify(e.data)||""}else{n=e.errorResponse}r=r||"application/json";if(e.responseHeaders){return"HTTP/1.1 "+t(e)+"\r\n"+e.responseHeaders+"dataserviceversion: 2.0\r\n\r\n"+n+"\r\n"}else{return"HTTP/1.1 "+t(e)+"\r\nContent-Type: "+r+"\r\nContent-Length: "+n.length+"\r\ndataserviceversion: 2.0\r\n\r\n"+n+"\r\n"}};var a=function(e,t,r,a,s){var o;var i=function(e,t,r){o={success:true,data:e,status:t,statusCode:r&&r.status,responseHeaders:r&&r.getAllResponseHeaders()}};var u=function(e,t,r){o={success:false,data:undefined,status:t,error:r,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};jQuery.ajax({type:r,async:false,url:e,headers:s,data:t,dataType:"json",success:i,error:u});if(o.statusCode===400||o.statusCode===404){var f=n(o);throw new Error(f)}a.push(n(o))};var o=function(e,t){var r;var a;var s=function(e,t,n){r={success:true,data:e,status:t,statusCode:n&&n.status,responseHeaders:n&&n.getAllResponseHeaders()}};var o=function(e,t,n){r={success:false,data:undefined,status:t,error:n,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};jQuery.ajax({async:false,url:e,dataType:"json",success:s,error:o});var a;if(e.indexOf("$count")!==-1){a=n(r,"text/plain")}else{a=n(r)}t.push("\r\nContent-Type: application/http\r\n"+"Content-Length: "+a.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+a)};var i=function(e){var t={};e.split("HTTP/1.1")[1].split("{")[0].split("\n").forEach(function(e){if(e.indexOf(":")!==-1){var r=e.split(":");t[r[0].trim()]=r[1].trim()}});delete t["Content-Length"];return t};var u=e.requestBody;var f=new RegExp("--batch_[a-z0-9-]*");var p=f.exec(u)[0];if(p){var d=[];var l=u.split(p);var h=e.url.split("$")[0];var v=new RegExp("PUT (.*) HTTP");var _=new RegExp("MERGE (.*) HTTP");var E=new RegExp("POST (.*) HTTP");var y=new RegExp("DELETE (.*) HTTP");var g=new RegExp("GET (.*) HTTP");for(var m=1;m<l.length-1;m++){var T=l[m];if(g.test(T)&&T.indexOf("multipart/mixed")===-1){if(v.test(T)||E.test(T)||y.test(T)){e.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");r.debug("MockServer: response sent with: 400");return true}o(h+g.exec(T)[1],d)}else{var S=jQuery.extend(true,{},s._oMockdata);var M=[];var O=T.substring(T.indexOf("boundary=")+9,T.indexOf("\r\n\r\n"));var R=T.split("--"+O);try{for(var k=1;k<R.length-1;k++){var b=R[k];var x;if(g.test(b)){s._oMockdata=S;e.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");r.debug("MockServer: response sent with: 400");return}else{var x=b.substring(b.indexOf("{"),b.lastIndexOf("}")+1),N=i(b),D,P;if(v.test(b)){P="PUT";D=v.exec(b)[1]}else if(_.test(b)){P="MERGE";D=_.exec(b)[1]}else if(E.test(b)){P="POST";D=E.exec(b)[1]}else if(y.test(b)){P="DELETE";x=undefined;D=y.exec(b)[1]}a(h+D,x,P,M,N)}}var I="\r\nContent-Type: multipart/mixed; boundary=ejjeeffe1\r\n\r\n--ejjeeffe1";for(var w=0;w<M.length;w++){I+="\r\nContent-Type: application/http\r\n"+"Content-Length: "+M[w].length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+M[w]+"--ejjeeffe1"}I+="--\r\n";d.push(I)}catch(e){s._oMockdata=S;var A="\r\nContent-Type: application/http\r\n"+"Content-Length: "+e.message.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+e.message;d.push(A)}}}var C="--ejjeeffe0";for(var H=0;H<d.length;H++){C+=d[H]+"--ejjeeffe0"}C+="--";var N={"Content-Type":"multipart/mixed; boundary=ejjeeffe0"};c(e,N);e.respond(202,N,C);r.debug("MockServer: response sent with: 202, "+C)}else{e.respond(202)}return true}});jQuery.each(this._mEntitySets,function(e,t){v.push({method:"GET",path:new RegExp("("+e+")/\\$count/?(.*)?"),response:function(e,t,n){r.debug("MockServer: incoming request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.GET+t+":before",{oXhr:e,sUrlParams:n});s.fireEvent(a.HTTPMETHOD.GET+":before",{oXhr:e,sUrlParams:n});var o={"Content-Type":"text/plain;charset=utf-8"};c(e,o);try{var i=s._oMockdata[t];if(i){var u={results:jQuery.extend(true,[],i)};if(n){var f=decodeURIComponent(n).replace("?","&").split("&");f=l(f);if(f.length>1){f=s._orderQueryOptions(f)}jQuery.each(f,function(e,r){s._applyQueryOnCollection(u,r,t,f)})}s.fireEvent(a.HTTPMETHOD.GET+t+":after",{oXhr:e,oFilteredData:u});s.fireEvent(a.HTTPMETHOD.GET+":after",{oXhr:e,oFilteredData:u});e.respond(200,o,""+u.results.length);r.debug("MockServer: response sent with: 200, "+u.results.length)}else{s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){e.respond(t.error.code,o,JSON.stringify(t))}else{r.error("MockServer: request failed due to invalid system query options value!");e.respond(parseInt(t.message||t.number))}}return true}});v.push({method:"GET",path:new RegExp("("+e+")/?(\\?(.*))?"),response:function(e,t,n){r.debug("MockServer: incoming request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.GET+t+":before",{oXhr:e,sUrlParams:n});s.fireEvent(a.HTTPMETHOD.GET+":before",{oXhr:e,sUrlParams:n});var o={"Content-Type":"application/json;charset=utf-8"};c(e,o);try{var i=s._oMockdata[t];if(i){var u={results:jQuery.extend(true,[],i)};if(n){var f=decodeURIComponent(n).replace("?","&").split("&");f=l(f);if(f.length>1){f=s._orderQueryOptions(f)}jQuery.each(f,function(e,r){s._applyQueryOnCollection(u,r,t,f)})}s.fireEvent(a.HTTPMETHOD.GET+t+":after",{oXhr:e,oFilteredData:u});s.fireEvent(a.HTTPMETHOD.GET+":after",{oXhr:e,oFilteredData:u});e.respond(200,o,JSON.stringify({d:u}));r.debug("MockServer: response sent with: 200, "+JSON.stringify({d:u}))}else{s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){e.respond(t.error.code,o,JSON.stringify(t))}else{r.debug("MockServer: response sent with: "+parseInt(t.message||t.number));e.respond(parseInt(t.message||t.number))}}return true}});v.push({method:"GET",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/?(\\?(.*))?"),response:function(e,t,o,i){r.debug("MockServer: incoming request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.GET+t+":before",{oXhr:e,sKeys:o,sUrlParams:i});s.fireEvent(a.HTTPMETHOD.GET+":before",{oXhr:e,sKeys:o,sUrlParams:i});var u={"Content-Type":"application/json;charset=utf-8"};try{var f=jQuery.extend(true,{},p(t,o));if(!n(f)){if(i){var c=decodeURIComponent(i).replace("?","&").split("&");c=l(c);if(c.length>1){c=s._orderQueryOptions(c)}jQuery.each(c,function(e,r){f.entry=s._applyQueryOnEntry(f.entry,r,t)})}s.fireEvent(a.HTTPMETHOD.GET+t+":after",{oXhr:e,oEntry:f.entry});s.fireEvent(a.HTTPMETHOD.GET+":after",{oXhr:e,oEntry:f.entry});e.respond(200,u,JSON.stringify({d:f.entry}));r.debug("MockServer: response sent with: 200, "+JSON.stringify({d:f.entry}))}else{s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){e.respond(t.error.code,u,JSON.stringify(t))}else{r.debug("MockServer: response sent with: "+parseInt(t.message||t.number));e.respond(parseInt(t.message||t.number))}}return true}});jQuery.each(t.navprops,function(t,n){v.push({method:"GET",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/("+t+")/\\$count/?(.*)?"),response:function(e,t,n,o,i){r.debug("MockServer: incoming request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.GET+t+":before",{oXhr:e,sKeys:n,sNavProp:o,sUrlParams:i});s.fireEvent(a.HTTPMETHOD.GET+":before",{oXhr:e,sKeys:n,sNavProp:o,sUrlParams:i});var u={"Content-Type":"text/plain;charset=utf-8"};c(e,u);try{var f=p(t,n);if(f){var d,h={};d=s._resolveNavigation(t,f.entry,o);var v=s._mEntitySets[t].navprops[o].to.multiplicity;if(v==="*"){h={results:jQuery.extend(true,[],d)}}else{h=jQuery.extend(true,{},d[0])}if(d&&d.length!==0){if(i){var _=decodeURIComponent(i).replace("?","&").split("&");_=l(_);if(_.length>1){_=s._orderQueryOptions(_)}if(v==="*"){jQuery.each(_,function(e,r){s._applyQueryOnCollection(h,r,s._mEntitySets[t].navprops[o].to.entitySet,_)})}else{jQuery.each(_,function(e,r){h=s._applyQueryOnEntry(h,r,s._mEntitySets[t].navprops[o].to.entitySet)})}}}s.fireEvent(a.HTTPMETHOD.GET+t+":after",{oXhr:e,oFilteredData:h});s.fireEvent(a.HTTPMETHOD.GET+":after",{oXhr:e,oFilteredData:h});h.results=h.results||[];e.respond(200,u,""+h.results.length);r.debug("MockServer: response sent with: 200, "+h.results.length)}else{s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){e.respond(t.error.code,u,JSON.stringify(t))}else{r.debug("MockServer: response sent with: "+parseInt(t.message||t.number));e.respond(parseInt(t.message||t.number))}}return true}});v.push({method:"GET",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/("+t+")/?(\\?(.*))?"),response:function(e,t,n,o,i){r.debug("MockServer: incoming request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.GET+t+":before",{oXhr:e,sKeys:n,sNavProp:o,sUrlParams:i});s.fireEvent(a.HTTPMETHOD.GET+":before",{oXhr:e,sKeys:n,sNavProp:o,sUrlParams:i});var u={"Content-Type":"application/json;charset=utf-8"};c(e,u);try{var f=p(t,n);if(f){var d,h={};d=s._resolveNavigation(t,f.entry,o,f.entry);var v=s._mEntitySets[t].navprops[o].to.multiplicity;if(v==="*"){h={results:jQuery.extend(true,[],d)}}else{h=jQuery.extend(true,{},d[0])}if(d&&d.length!==0){if(i){var _=decodeURIComponent(i).replace("?","&").split("&");_=l(_);if(_.length>1){_=s._orderQueryOptions(_)}if(v==="*"){jQuery.each(_,function(e,r){s._applyQueryOnCollection(h,r,s._mEntitySets[t].navprops[o].to.entitySet,_)})}else{jQuery.each(_,function(e,r){h=s._applyQueryOnEntry(h,r,s._mEntitySets[t].navprops[o].to.entitySet)})}}}s.fireEvent(a.HTTPMETHOD.GET+t+":after",{oXhr:e,oFilteredData:h});s.fireEvent(a.HTTPMETHOD.GET+":after",{oXhr:e,oFilteredData:h});e.respond(200,u,JSON.stringify({d:h}));r.debug("MockServer: response sent with: 200, "+JSON.stringify({d:h}))}else{s._logAndThrowMockServerCustomError(404,s._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){e.respond(t.error.code,u,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}})});v.push({method:"POST",path:new RegExp("("+e+")(\\(([^/\\?#]+)\\)/?(.*)?)?"),response:function(e,n,o,i,u){var f=false;if(e.requestHeaders["x-http-method"]==="MERGE"){f=true}r.debug("MockServer: incoming create request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.POST+n+":before",{oXhr:e,sKeys:i,sNavName:u});s.fireEvent(a.HTTPMETHOD.POST+":before",{oXhr:e,sKeys:i,sNavName:u});var c=null;var l=null;var v=405;try{if(i&&!i.split("=")[1]){i=s._mEntitySets[n].keys[0]+"="+i}var _=d(t,decodeURIComponent(i),u);if(_){var E=h(e,_,i,u);if(E){l={"Content-Type":"application/json;charset=utf-8"};s.fireEvent(a.HTTPMETHOD.POST+n+":after",{oXhr:e,oEntity:E});s.fireEvent(a.HTTPMETHOD.POST+":after",{oXhr:e,oEntity:E});if(f){var y=p(n,i);if(y){jQuery.extend(s._oMockdata[n][y.index],E)}v=204}else{var g=s._getRootUri()+_+"("+s._createKeysString(s._mEntitySets[_],E)+")";c=JSON.stringify({d:E,uri:g});s._oMockdata[_]=s._oMockdata[_].concat([E]);v=201}}}e.respond(v,l,c);r.debug("MockServer: response sent with: "+v+", "+c)}catch(t){if(t.error){var m={"Content-Type":"text/plain;charset=utf-8"};e.respond(t.error.code,m,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}});v.push({method:"PUT",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(e,n,o,i){r.debug("MockServer: incoming update request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.PUT+n+":before",{oXhr:e,sKeys:o,sNavName:i});s.fireEvent(a.HTTPMETHOD.PUT+":before",{oXhr:e,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var l=d(t,decodeURIComponent(o),i);if(l){var v=h(e,l,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};s.fireEvent(a.HTTPMETHOD.PUT+n+":after",{oXhr:e,oEntity:v});s.fireEvent(a.HTTPMETHOD.PUT+":after",{oXhr:e,oEntity:v});var _=p(n,o);if(_){s._oMockdata[n][_.index]=v}u=204}}e.respond(u,c,f);r.debug("MockServer: response sent with: "+u+", "+f)}catch(t){if(t.error){var E={"Content-Type":"text/plain;charset=utf-8"};e.respond(t.error.code,E,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}});v.push({method:"MERGE",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(e,n,o,i){r.debug("MockServer: incoming merge update request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.MERGE+n+":before",{oXhr:e,sKeys:o,sNavName:i});s.fireEvent(a.HTTPMETHOD.MERGE+":before",{oXhr:e,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var l=d(t,decodeURIComponent(o),i);if(l){var v=h(e,l,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};s.fireEvent(a.HTTPMETHOD.MERGE+n+":after",{oXhr:e,oEntity:v});s.fireEvent(a.HTTPMETHOD.MERGE+":after",{oXhr:e,oEntity:v});var _=p(n,o);if(_){jQuery.extend(s._oMockdata[n][_.index],v)}u=204}}e.respond(u,c,f);r.debug("MockServer: response sent with: "+u+", "+f)}catch(t){if(t.error){var E={"Content-Type":"text/plain;charset=utf-8"};e.respond(t.error.code,E,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}});v.push({method:"PATCH",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(e,n,o,i){r.debug("MockServer: incoming patch update request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.PATCH+n+":before",{oXhr:e,sKeys:o,sNavName:i});s.fireEvent(a.HTTPMETHOD.PATCH+":before",{oXhr:e,sKeys:o,sNavName:i});var u=405;var f=null;var c=null;try{var l=d(t,decodeURIComponent(o),i);if(l){var v=h(e,l,o,i);if(v){c={"Content-Type":"application/json;charset=utf-8"};s.fireEvent(a.HTTPMETHOD.PATCH+n+":after",{oXhr:e,oEntity:v});s.fireEvent(a.HTTPMETHOD.PATCH+":after",{oXhr:e,oEntity:v});var _=p(n,o);if(_){jQuery.extend(s._oMockdata[n][_.index],v)}u=204}}e.respond(u,c,f);r.debug("MockServer: response sent with: "+u+", "+f)}catch(t){if(t.error){var E={"Content-Type":"text/plain;charset=utf-8"};e.respond(t.error.code,E,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}});v.push({method:"DELETE",path:new RegExp("("+e+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(e,t,n,o){r.debug("MockServer: incoming delete request for url: "+e.url);s.fireEvent(a.HTTPMETHOD.DELETE+t+":before",{oXhr:e});s.fireEvent(a.HTTPMETHOD.DELETE+":before",{oXhr:e});var i=204;try{var u=p(t,n);if(u){s._oMockdata[t].splice(u.index,1)}else{i=400}s.fireEvent(a.HTTPMETHOD.DELETE+t+":after",{oXhr:e});s.fireEvent(a.HTTPMETHOD.DELETE+":after",{oXhr:e});e.respond(i,null,null);r.debug("MockServer: response sent with: "+i)}catch(t){if(t.error){var f={"Content-Type":"text/plain;charset=utf-8"};e.respond(t.error.code,f,JSON.stringify(t))}else{e.respond(parseInt(t.message||t.number));r.debug("MockServer: response sent with: "+parseInt(t.message||t.number))}}return true}})});this.setRequests(v)};a.prototype._orderQueryOptions=function(e){var t,r,n,a,s,o,i,u,f,c,p=[];var d=this;jQuery.each(e,function(p,l){var h=e.indexOf(l);switch(l.split("=")[0]){case"$top":a=h;break;case"$skip":n=h;break;case"$orderby":s=h;break;case"$expand":i=h;break;case"$filter":t=h;break;case"$select":o=h;break;case"$inlinecount":r=h;break;case"$format":u=h;break;case"search-focus":c=h;break;case"search":f=h;break;default:if(l.split("=")[0].indexOf("$")===0){d._logAndThrowMockServerCustomError(400,d._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,l.split("=")[0])}}});if(i>=0){p.push(e[i])}if(t>=0){p.push(e[t])}if(c>=0){p.push(e[c])}if(f>=0){p.push(e[f])}if(r>=0){p.push(e[r])}if(s>=0){p.push(e[s])}if(n>=0){p.push(e[n])}if(a>=0){p.push(e[a])}if(o>=0){p.push(e[o])}if(u>=0){p.push(e[u])}return p};a.prototype._removeAllRequestHandlers=function(){var e=this.getRequests();var t=e.length;for(var r=0;r<t;r++){a._removeResponse(e[r].response)}};a.prototype._removeAllFilters=function(){for(var e=0;e<this._aFilters.length;e++){a._removeFilter(this._aFilters[e])}this._aFilters=null};a.prototype._addRequestHandler=function(e,t,n){e=e?e.toUpperCase():e;if(typeof e!=="string"){throw new Error("Error in request configuration: value of 'method' has to be a string")}if(!(typeof t==="string"||t instanceof RegExp)){throw new Error("Error in request configuration: value of 'path' has to be a string or a regular expression")}if(typeof n!=="function"){throw new Error("Error in request configuration: value of 'response' has to be a function")}var a=this._getRootUri();a=a&&new RegExp(this._escapeStringForRegExp(a));if(t&&!(t instanceof RegExp)){t=new RegExp(this._createRegExpPattern(t))}var s=this._createRegExp(a?a.source+t.source:t.source);this._addFilter(this._createFilter(e,s));this._oServer.respondWith(e,s,n);r.debug("MockServer: adding "+e+" request handler for pattern "+s)};a.prototype._createRegExp=function(e){return new RegExp("^"+e+"$")};a.prototype._createRegExpPattern=function(e){return e.replace(/:([\w\d]+)/g,"([^/]+)")};a.prototype._escapeStringForRegExp=function(e){return e.replace(/[\\\/\[\]\{\}\(\)\-\*\+\?\.\^\$\|]/g,"\\$&")};a.prototype._trim=function(e){return e&&e.replace(/^\s+|\s+$/g,"")};a.prototype._isValidNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};a.prototype._getDateTime=function(e){if(!e){return}return"datetime'"+new Date(Number(e.replace("/Date(","").replace(")/",""))).toJSON().substring(0,19)+"'"};a.prototype._getJsonDate=function(e){if(!e){return}var t=function(e){var t=jQuery.map(e.slice(0,-5).split(/\D/),function(e){return parseInt(e)||0});t[1]-=1;t=new Date(Date.UTC.apply(Date,t));var r=e.slice(-5);var n=parseInt(r)/100;if(r.slice(0,1)==="+"){n*=-1}t.setHours(t.getHours()+n);return t.getTime()};if(e.indexOf("datetimeoffset")>-1){return"/Date("+t(e.substring("datetimeoffset'".length,e.length-1))+")/"}else{return"/Date("+t(e.substring("datetime'".length,e.length-1))+")/"}};a.prototype._addFilter=function(e){this._aFilters.push(e);a._addFilter(e)};a.prototype._createFilter=function(e,t){return function(r,n,a,s,o){return e===r&&t.test(n)}};a.prototype._logAndThrowMockServerCustomError=function(e,t,n){if(t.indexOf("##")>-1&&n){t=t.replace("##","'"+n+"'")}r.error("MockServer: "+t);throw{error:{code:e,message:{lang:"en",value:t}}}};a.prototype.destroy=function(t){e.prototype.destroy.apply(this,arguments);this.stop();var r=a._aServers;var n=r.indexOf(this);r.splice(n,1)};a._aFilters=[];a._oServer=null;a._aServers=[];a._getInstance=function(){if(!this._oServer){this._oServer=window.sinon.fakeServer.create();this._oServer.autoRespond=true}return this._oServer};a.config=function(e){var t=this._getInstance();t.autoRespond=e.autoRespond===false?false:true;t.autoRespondAfter=e.autoRespondAfter||0;t.fakeHTTPMethods=e.fakeHTTPMethods||false};a.respond=function(){this._getInstance().respond()};a.startAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].start()}};a.stopAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].stop()}this._getInstance().restore();this._oServer=null};a.destroyAll=function(){this.stopAll();while(this._aServers.length>0){this._aServers[0].destroy()}};a.HTTPMETHOD={GET:"GET",POST:"POST",DELETE:"DELETE",PUT:"PUT",MERGE:"MERGE",PATCH:"PATCH"};a._addFilter=function(e){this._aFilters.push(e)};a._removeFilter=function(e){this._aFilters.splice(this._aFilters.indexOf(e),1)};a._removeResponse=function(e){var t=this._oServer.responses;var r=t.length;for(var n=0;n<r;n++){if(t[n].response===e){t.splice(n,1);return true}}return false};window.sinon.FakeXMLHttpRequest.useFilters=true;window.sinon.FakeXMLHttpRequest.addFilter(function(e,t,r,n,s){var o=a._aFilters;for(var i=0;i<o.length;i++){var u=o[i];if(u(e,t,r,n,s)){return false}}return true});var s=function(e){if(/.*\.json$/i.test(e)){return"JSON"}if(/.*\.xml$/i.test(e)){return"XML"}if(/.*metadata$/i.test(e)){return"XML"}return null};window.sinon.FakeXMLHttpRequest.prototype.respondFile=function(e,t,r){var n=jQuery.sap.sjax({url:r,dataType:"text"});if(!n.success){throw new Error("Could not load file from: "+r)}var a=n.data;var o=s(r);if(this["respond"+o]){this["respond"+o](e,t,a)}else{this.respond(e,t,a)}};window.sinon.FakeXMLHttpRequest.prototype.respondJSON=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/json";this.respond(e,t,typeof r==="string"?r:JSON.stringify(r))};window.sinon.FakeXMLHttpRequest.prototype.respondXML=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/xml";this.respond(e,t,r)};return a});
//# sourceMappingURL=MockServer.js.map