/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/thirdparty/URI","sap/base/Log","sap/base/util/extend","sap/base/strings/escapeRegExp","sap/ui/thirdparty/jquery","sap/ui/core/IconPool","./Core"],function(e,r,t,o,n,jQuery,a){"use strict";var i=sap.ui.getCore().getConfiguration();var s=i.getLanguage();var p=i.getAppCacheBusterMode()==="sync";var c=i.getAppCacheBusterMode()==="batch";var u={index:{},active:false};var f,l,d,g,v;var y=document.baseURI.replace(/\?.*|#.*/g,"");var h=r(sap.ui.require.toUrl("")+"/../");var b=h.toString();if(h.is("relative")){h=h.absoluteTo(y)}var L=h.normalize().toString();var m=r("resources").absoluteTo(L).toString();var x=new RegExp("^"+n(m));var C=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/"}return e};var A=function(e,r){var n=u.index;var a;var i;var f;if(Array.isArray(e)&&!c){e.forEach(function(e){A(e,r)})}else if(Array.isArray(e)&&c){var l=C(e[0]);var d=[];t.debug('sap.ui.core.AppCacheBuster.register("'+l+'"); // BATCH MODE!');var g=R.normalizeURL(l);t.debug('  --\x3e normalized to: "'+g+'"');e.forEach(function(e){i=C(e);var r=R.normalizeURL(i);if(!n[f]){d.push(r)}});if(d.length>0){var i=g+"sap-ui-cachebuster-info.json?sap-ui-language="+s;a={url:i,type:"POST",async:!p&&!!r,dataType:"json",contentType:"text/plain",data:d.join("\n"),success:function(e){R.onIndexLoaded(i,e);o(n,e)},error:function(){t.error('Failed to batch load AppCacheBuster index file from: "'+i+'".')}}}}else{e=C(e);t.debug('sap.ui.core.AppCacheBuster.register("'+e+'");');f=R.normalizeURL(e);t.debug('  --\x3e normalized to: "'+f+'"');if(!n[f]){var i=f+"sap-ui-cachebuster-info.json?sap-ui-language="+s;a={url:i,async:!p&&!!r,dataType:"json",success:function(e){R.onIndexLoaded(i,e);n[f]=e},error:function(){t.error('Failed to load AppCacheBuster index file from: "'+i+'".')}}}}if(a){var v=R.onIndexLoad(a.url);if(v!=null){t.info('AppCacheBuster index file injected for: "'+i+'".');a.success(v)}else{if(a.async){var y=r.startTask("load "+i);var h=a.success,b=a.error;Object.assign(a,{success:function(e){h.apply(this,arguments);r.finishTask(y)},error:function(){b.apply(this,arguments);r.finishTask(y,false)}})}t.info('Loading AppCacheBuster index file from: "'+i+'".');jQuery.ajax(a)}}};var R={boot:function(e){var t=i.getAppCacheBuster();if(t&&t.length>0){t=t.slice();var o=true;var n=String(t[0]).toLowerCase();if(t.length===1){if(n==="true"||n==="x"){var a=r(b);t=a.is("relative")?[a.toString()]:[]}else if(n==="false"){o=false}}if(o){R.init();A(t,e)}}},init:function(){u.active=true;f=e.prototype.validateProperty;l=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");d=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var r=R.convertURL;var o=R.normalizeURL;var n=function(e){if(this.active===true&&e&&typeof e==="string"){e=o(e);return!e.match(x)}return false}.bind(u);g=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){if(t&&n(t)){arguments[1]=r(t)}g.apply(this,arguments)};v=XMLHttpRequest.prototype.open;e.prototype.validateProperty=function(e,t){var o=this.getMetadata(),a=o.getProperty(e),i;if(a&&a.type==="sap.ui.core.URI"){i=Array.prototype.slice.apply(arguments);try{if(n(i[1])){i[1]=r(i[1])}}catch(e){}}return f.apply(this,i||arguments)};a._convertUrl=function(e){return r(e)};var i=function(e){var t={get:e.get,set:function(t){if(n(t)){t=r(t)}e.set.call(this,t)},enumerable:e.enumerable,configurable:e.configurable};t.set._sapUiCoreACB=true;return t};var s=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",i(l))}catch(e){t.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);s=true}try{Object.defineProperty(HTMLLinkElement.prototype,"href",i(d))}catch(e){t.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+e);s=true}if(s){this.exit()}},exit:function(){e.prototype.validateProperty=f;delete a._convertUrl;if(XMLHttpRequest.prototype.open===v){XMLHttpRequest.prototype.open=g}var r;if((r=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&r.set&&r.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",l)}if((r=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&r.set&&r.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",d)}u.index={};u.active=false;u={index:{},active:false}},register:function(e){A(e)},convertURL:function(e){t.debug('sap.ui.core.AppCacheBuster.convertURL("'+e+'");');var r=u.index;if(r&&e&&!/^#/.test(e)){var o=R.normalizeURL(e);t.debug('  --\x3e normalized to: "'+o+'"');if(o&&R.handleURL(o)){for(var n in r){var a=r[n],i,s;if(n&&o.length>=n.length&&o.slice(0,n.length)===n){i=o.slice(n.length);s=i.match(/([^?#]*)/)[1];if(a[s]){e=n+"~"+a[s]+"~/"+i;t.debug('  ==> rewritten to "'+e+'";');break}}}}}return e},normalizeURL:function(e){var t=r(e||"./");if(t.is("relative")){t=t.absoluteTo(y)}return t.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString()},handleURL:function(e){return true},onIndexLoad:function(e){return null},onIndexLoaded:function(e,r){}};var U=i.getAppCacheBusterHooks();if(U){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof U[e]==="function"){R[e]=U[e]}})}return R},true);
//# sourceMappingURL=AppCacheBuster.js.map